{% extends 'seller/base_seller.html' %}
{% block content %}
<section class="space-y-3">
	<header class="flex justify-between items-center">
		<div>
			<h1 class="text-base font-semibold">Disponibilidades</h1>
			<p class="text-xs opacity-70">Stock disponible para ventas</p>
		</div>
		{% if current_stock_day %}
		<div class="badge badge-primary badge-sm">{{ current_stock_day.date }}</div>
		{% endif %}
	</header>

	<!-- Filtros de búsqueda -->
	<div class="card bg-base-100 shadow-sm border border-base-200">
		<div class="card-body p-3">
			<form method="get" class="flex gap-2 items-center">
				<input 
					type="text" 
					name="search" 
					value="{{ current_search }}"
					placeholder="Buscar por proveedor, variedad, tipo de caja..." 
					class="input input-sm input-bordered flex-1"
				>
				<button type="submit" class="btn btn-sm btn-primary">
					<i class="la la-search"></i> Buscar
				</button>
				{% if current_search %}
				<a href="{% url 'sellers:stocks' %}" class="btn btn-sm btn-ghost">Limpiar</a>
				{% endif %}
			</form>
		</div>
	</div>

	<!-- Resumen rápido -->
	<div class="grid grid-cols-2 gap-2 md:grid-cols-4">
		<div class="card bg-base-100 shadow-sm border border-base-200">
			<div class="card-body p-3">
				<h6 class="text-[10px] font-semibold uppercase opacity-60">Total Cajas</h6>
				<p class="text-lg font-bold">{{ total_boxes|default:0 }}</p>
				<span class="text-[10px] opacity-60">Disponibles</span>
			</div>
		</div>
		<div class="card bg-base-100 shadow-sm border border-base-200">
			<div class="card-body p-3">
				<h6 class="text-[10px] font-semibold uppercase opacity-60">Total Tallos</h6>
				<p class="text-lg font-bold">{{ total_stems|default:0 }}</p>
				<span class="text-[10px] opacity-60">En stock</span>
			</div>
		</div>
		{% for box_type, data in box_summary.items %}
		<div class="card bg-base-100 shadow-sm border border-base-200">
			<div class="card-body p-3">
				<h6 class="text-[10px] font-semibold uppercase opacity-60">{{ box_type }}</h6>
				<p class="text-lg font-bold">{{ data.quantity }}</p>
				<span class="text-[10px] opacity-60">{{ data.stems }} tallos</span>
			</div>
		</div>
		{% endfor %}
	</div>

	<!-- Lista de stock -->
	<div class="card bg-base-100 shadow-sm border border-base-200">
		<div class="card-body p-3">
			<div class="flex justify-between items-center mb-3">
				<h2 class="text-sm font-semibold">Stock Detallado por Proveedor</h2>
				<a href="{% url 'sellers:create_order' %}" class="btn btn-sm btn-primary">
					<i class="la la-plus"></i> Nueva Orden
				</a>
			</div>
			
			<div class="space-y-2">
				<!-- Vista de escritorio -->
				<div class="hidden lg:block">
					<table class="table table-xs w-full">
						<thead>
							<tr class="text-[10px] opacity-60">
								<th>Proveedor</th>
								<th>Tipo</th>
								<th>Variedades</th>
								<th class="text-right">Cajas</th>
								<th class="text-right">Tallos</th>
								<th class="text-right">Costo/T</th>
								<th class="text-right">Costo/C</th>
								<th class="text-right">Margen</th>
								<th class="text-center">Acciones</th>
							</tr>
						</thead>
						<tbody>
							{% for item in stock_items %}
							<tr class="text-[11px]">
								<td>
									<div class="font-medium">{{ item.partner.short_name|default:item.partner.name }}</div>
								</td>
								<td>
									<span class="badge badge-ghost badge-sm">{{ item.box_model }}</span>
								</td>
								<td>
									<div class="max-w-40">
										{% for box_item in item.boxitems_set.all %}
										<div class="text-[10px] mb-1">
											<span class="font-medium">{{ box_item.product.name }}</span>
											<br>
											<span class="opacity-60">{{ box_item.length }}cm - {{ box_item.qty_stem_flower }}t</span>
										</div>
										{% empty %}
										<span class="text-[10px] opacity-50">Sin detalles</span>
										{% endfor %}
									</div>
								</td>
								<td class="text-right font-medium">{{ item.quantity }}</td>
								<td class="text-right">{{ item.tot_stem_flower }}</td>
								<td class="text-right">
									{% for box_item in item.boxitems_set.all %}
									<div class="text-[10px]">${{ box_item.stem_cost_price|floatformat:3 }}</div>
									{% empty %}
									<span class="text-[10px] opacity-50">N/A</span>
									{% endfor %}
								</td>
								<td class="text-right">${{ item.tot_cost_price_box|floatformat:2 }}</td>
								<td class="text-right">{{ item.profit_margin|floatformat:1 }}%</td>
								<td class="text-center">
									<div class="dropdown dropdown-end">
										<div tabindex="0" role="button" class="btn btn-xs btn-primary">
											<i class="la la-cart-plus"></i>
										</div>
										<ul tabindex="0" class="dropdown-content z-10 menu p-1 shadow bg-base-100 rounded-box w-40 text-[10px]">
											<li>
												<a href="{% url 'sellers:create_order' %}?stock_detail={{ item.id }}" class="gap-2">
													<i class="la la-plus"></i>
													Orden completa
												</a>
											</li>
											{% for box_item in item.boxitems_set.all %}
											<li>
												<a href="{% url 'sellers:create_order' %}?box_item={{ box_item.id }}" class="gap-2">
													<i class="la la-leaf"></i>
													{{ box_item.product.name|truncatechars:15 }}
												</a>
											</li>
											{% endfor %}
										</ul>
									</div>
								</td>
							</tr>
							{% empty %}
							<tr>
								<td colspan="9" class="text-center text-xs opacity-50 py-4">
									{% if current_search %}
									No se encontraron resultados para "{{ current_search }}"
									{% else %}
									No hay stock disponible
									{% endif %}
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				
				<!-- Vista móvil/tablet -->
				<div class="lg:hidden space-y-2">
					{% for item in stock_items %}
					<div class="card bg-base-200 border border-base-300">
						<div class="card-body p-3">
							<div class="flex justify-between items-start mb-2">
								<div>
									<h3 class="font-medium text-sm">{{ item.partner.short_name|default:item.partner.name }}</h3>
									<div class="flex gap-2 items-center mt-1">
										<span class="badge badge-ghost badge-sm">{{ item.box_model }}</span>
										<span class="text-xs opacity-60">{{ item.quantity }} cajas</span>
									</div>
								</div>
								<div class="dropdown dropdown-end">
									<div tabindex="0" role="button" class="btn btn-xs btn-primary">
										<i class="la la-cart-plus"></i>
									</div>
									<ul tabindex="0" class="dropdown-content z-10 menu p-1 shadow bg-base-100 rounded-box w-40 text-[10px]">
										<li>
											<a href="{% url 'sellers:create_order' %}?stock_detail={{ item.id }}" class="gap-2">
												<i class="la la-plus"></i>
												Orden completa
											</a>
										</li>
										{% for box_item in item.boxitems_set.all %}
										<li>
											<a href="{% url 'sellers:create_order' %}?box_item={{ box_item.id }}" class="gap-2">
												<i class="la la-leaf"></i>
												{{ box_item.product.name|truncatechars:15 }}
											</a>
										</li>
										{% endfor %}
									</ul>
								</div>
							</div>
							
							<!-- Variedades -->
							<div class="mb-2">
								<span class="text-xs font-medium opacity-70">Variedades:</span>
								<div class="grid grid-cols-1 sm:grid-cols-2 gap-1 mt-1">
									{% for box_item in item.boxitems_set.all %}
									<div class="bg-base-100 rounded p-2 text-xs">
										<div class="font-medium">{{ box_item.product.name }}</div>
										<div class="opacity-60">{{ box_item.length }}cm - {{ box_item.qty_stem_flower }} tallos</div>
										<div class="opacity-60">${{ box_item.stem_cost_price|floatformat:3 }}/tallo</div>
									</div>
									{% empty %}
									<span class="text-xs opacity-50">Sin detalles</span>
									{% endfor %}
								</div>
							</div>
							
							<!-- Stats -->
							<div class="grid grid-cols-3 gap-2 text-center text-xs">
								<div>
									<div class="font-medium">{{ item.tot_stem_flower }}</div>
									<div class="opacity-60">Tallos</div>
								</div>
								<div>
									<div class="font-medium">${{ item.tot_cost_price_box|floatformat:2 }}</div>
									<div class="opacity-60">Costo/Caja</div>
								</div>
								<div>
									<div class="font-medium">{{ item.profit_margin|floatformat:1 }}%</div>
									<div class="opacity-60">Margen</div>
								</div>
							</div>
						</div>
					</div>
					{% empty %}
					<div class="text-center text-sm opacity-50 py-8">
						{% if current_search %}
						No se encontraron resultados para "{{ current_search }}"
						{% else %}
						No hay stock disponible
						{% endif %}
					</div>
					{% endfor %}
				</div>
			</div>
			
			<!-- Paginación -->
			{% if is_paginated %}
			<div class="flex justify-center mt-3">
				<div class="join">
					{% if page_obj.has_previous %}
					<a href="?page={{ page_obj.previous_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}" class="join-item btn btn-xs">❮</a>
					{% endif %}
					<button class="join-item btn btn-xs btn-active">{{ page_obj.number }}</button>
					{% if page_obj.has_next %}
					<a href="?page={{ page_obj.next_page_number }}{% if current_search %}&search={{ current_search }}{% endif %}" class="join-item btn btn-xs">❯</a>
					{% endif %}
				</div>
			</div>
			{% endif %}
		</div>
	</div>
</section>
{% endblock %}