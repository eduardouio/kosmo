{% extends 'seller/base_seller.html' %}

{% block content %}
<section class="space-y-3 pb-20" id="stockApp">
	<!-- Header móvil con búsqueda y fecha -->
	<header class="space-y-2">
		<div class="flex items-center gap-2">
			<input 
				type="text" 
				id="searchInput"
				placeholder="Buscar..." 
				class="input input-sm input-bordered flex-1"
			>
			{% if current_stock_day %}
			<div class="badge badge-primary whitespace-nowrap">{{ current_stock_day.date }}</div>
			{% else %}
			<div class="badge badge-primary whitespace-nowrap">2025-11-26</div>
			{% endif %}
		</div>
		<div>
			<h1 class="text-base font-semibold">Disponibilidades</h1>
			<p class="text-xs opacity-70">Stock disponible para ventas</p>
		</div>
	</header>

	<!-- Panel de filtros desplegable -->
	<div id="filterPanel" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleFilters()">
		<div class="absolute right-0 top-0 h-full w-80 max-w-[85vw] bg-base-100 shadow-xl overflow-y-auto" onclick="event.stopPropagation()">
			<div class="sticky top-0 bg-base-100 border-b border-base-200 p-4 flex justify-between items-center">
				<h3 class="font-semibold">Filtros</h3>
				<button onclick="toggleFilters()" class="btn btn-sm btn-circle btn-ghost">✕</button>
			</div>
			
			<div class="p-4 space-y-4">
				<!-- Filtros por proveedor -->
				<div>
					<h4 class="font-medium text-sm mb-2">Proveedores</h4>
					<div class="space-y-2" id="providerFilters">
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm checkbox-primary" value="SANTA CLARA GARDENS" checked>
							<span>Santa Clara Gardens</span>
						</label>
					</div>
					<button onclick="deselectAllProviders()" class="btn btn-xs btn-ghost mt-2">Desmarcar todos</button>
				</div>

				<!-- Filtros por color -->
				<div>
					<h4 class="font-medium text-sm mb-2">Colores</h4>
					<div class="space-y-2" id="colorFilters">
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="NO DEFINIDO" checked>
							<span>No Definido</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="LAVANDER" checked>
							<span>Lavander</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="BICOLOR" checked>
							<span>Bicolor</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="HOT PINK" checked>
							<span>Hot Pink</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="ORANGE" checked>
							<span>Orange</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="WHITE AND CREAM" checked>
							<span>White and Cream</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="YELLOWS" checked>
							<span>Yellows</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="SAND" checked>
							<span>Sand</span>
						</label>
					</div>
					<button onclick="deselectAllColors()" class="btn btn-xs btn-ghost mt-2">Desmarcar todos</button>
				</div>

				<!-- Filtros por longitud de tallo -->
				<div>
					<h4 class="font-medium text-sm mb-2">Longitud de Tallo</h4>
					<div class="space-y-2" id="lengthFilters">
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="40" checked>
							<span>40 cm</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="50" checked>
							<span>50 cm</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="60" checked>
							<span>60 cm</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="70" checked>
							<span>70 cm</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="80" checked>
							<span>80 cm</span>
						</label>
					</div>
					<button onclick="deselectAllLengths()" class="btn btn-xs btn-ghost mt-2">Desmarcar todos</button>
				</div>

				<!-- Filtros por modelo de caja -->
				<div>
					<h4 class="font-medium text-sm mb-2">Modelo de Caja</h4>
					<div class="space-y-2" id="boxModelFilters">
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="HB" checked>
							<span>HB</span>
						</label>
						<label class="flex items-center gap-2 text-sm cursor-pointer">
							<input type="checkbox" class="checkbox checkbox-sm" value="QB" checked>
							<span>QB</span>
						</label>
					</div>
					<button onclick="deselectAllBoxModels()" class="btn btn-xs btn-ghost mt-2">Desmarcar todos</button>
				</div>

				<!-- Botones de acción -->
				<div class="flex gap-2 pt-4 border-t border-base-200">
					<button onclick="clearAllFilters()" class="btn btn-sm btn-ghost flex-1">Limpiar</button>
					<button onclick="applyFilters()" class="btn btn-sm btn-primary flex-1">Aplicar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Lista de stock optimizada para móvil -->
	<div class="space-y-2" id="stockTable">
		<!-- Los datos se cargarán via JavaScript -->
	</div>
	
	<!-- Paginación -->
	<div class="flex justify-center">
		<div class="join" id="pagination">
			<!-- Paginación se generará via JavaScript -->
		</div>
	</div>

	<!-- Botón flotante para filtros -->
	<button onclick="toggleFilters()" class="btn btn-primary btn-circle fixed bottom-20 right-4 z-30 shadow-lg">
		<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
		</svg>
	</button>

	<!-- Botón flotante para crear orden (solo visible cuando hay items seleccionados) -->
	<button 
		id="createOrderBtn" 
		onclick="showOrderSummary()" 
		class="btn btn-accent fixed bottom-4 right-4 z-30 shadow-lg hidden gap-2"
	>
		<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
		</svg>
		<span>Crear Orden (<span id="selectedCount">0</span>)</span>
	</button>
</section>

<!-- Modal para resumen de orden -->
<div id="orderSummaryModal" class="modal">
	<div class="modal-box w-11/12 max-w-3xl max-h-[90vh]">
		<div class="flex justify-between items-center mb-4">
			<h3 class="font-bold text-lg">Resumen de Orden</h3>
			<button class="btn btn-sm btn-circle btn-ghost" onclick="closeOrderSummaryModal()">✕</button>
		</div>
		
		<!-- Items seleccionados -->
		<div class="mb-4">
			<h4 class="font-semibold text-sm mb-2">Items Seleccionados (<span id="modalSelectedCount">0</span>)</h4>
			<div class="overflow-x-auto max-h-60 border border-base-200 rounded-lg">
				<table class="table table-xs table-pin-rows">
					<thead>
						<tr class="bg-base-200">
							<th>Cant</th>
							<th>Variedad</th>
							<th>Largo</th>
							<th>Tallos</th>
							<th></th>
						</tr>
					</thead>
					<tbody id="selectedItemsList">
						<!-- Se llenará dinámicamente -->
					</tbody>
				</table>
			</div>
		</div>
		
		<form id="orderForm" class="space-y-4">
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div class="form-control">
					<label class="label">
						<span class="label-text">Cliente</span>
					</label>
					<select name="customer" class="select select-bordered select-sm" required>
						<option value="">Seleccionar cliente</option>
						<!-- Se llenarán desde el backend -->
					</select>
				</div>
				
				<div class="form-control">
					<label class="label">
						<span class="label-text">PO Cliente</span>
					</label>
					<input type="text" name="po_customer" class="input input-bordered input-sm" placeholder="Número de orden del cliente">
				</div>
				
				<div class="form-control">
					<label class="label">
						<span class="label-text">Fecha de Entrega</span>
					</label>
					<input type="date" name="delivery_date" class="input input-bordered input-sm">
				</div>
				
				<div class="form-control">
					<label class="label">
						<span class="label-text">Descuento (%)</span>
					</label>
					<input type="number" name="discount_percent" step="0.01" min="0" max="100" value="0" class="input input-bordered input-sm">
				</div>
			</div>
			
			<div class="modal-action">
				<button type="button" onclick="closeOrderSummaryModal()" class="btn btn-ghost">Cancelar</button>
				<button type="submit" class="btn btn-primary">Crear Orden de Venta</button>
			</div>
		</form>
	</div>
</div>

<!-- Modal antiguo (mantener para compatibilidad) -->
<div id="orderModal" class="modal hidden">
	<div class="modal-box w-11/12 max-w-2xl">
		<div class="flex justify-between items-center mb-4">
			<h3 class="font-bold text-lg">Crear Nueva Orden</h3>
			<button class="btn btn-sm btn-circle btn-ghost" onclick="closeOrderModal()">✕</button>
		</div>
		
		<form class="space-y-4">
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div class="form-control">
					<label class="label">
						<span class="label-text">Cliente</span>
					</label>
					<select name="customer" class="select select-bordered" required>
						<option value="">Seleccionar cliente</option>
						<!-- Se llenarán desde el backend -->
					</select>
				</div>
				
				<div class="form-control">
					<label class="label">
						<span class="label-text">PO Cliente</span>
					</label>
					<input type="text" name="po_customer" class="input input-bordered" placeholder="Número de orden del cliente">
				</div>
				
				<div class="form-control">
					<label class="label">
						<span class="label-text">Fecha de Entrega</span>
					</label>
					<input type="date" name="delivery_date" class="input input-bordered">
				</div>
				
				<div class="form-control">
					<label class="label">
						<span class="label-text">Descuento (%)</span>
					</label>
					<input type="number" name="discount_percent" step="0.01" min="0" max="100" value="0" class="input input-bordered">
				</div>
			</div>
			
			<div id="preselectedStock" class="hidden">
				<div class="alert alert-info">
					<i class="la la-info-circle"></i>
					<span id="preselectedInfo"></span>
				</div>
			</div>
			
			<div class="modal-action">
				<button type="button" onclick="closeOrderModal()" class="btn btn-ghost">Cancelar</button>
				<button type="submit" class="btn btn-primary">Crear Orden</button>
			</div>
		</form>
	</div>
</div>
{% endblock %}

{% block script %}
<script>
// Datos de prueba
const stockData = [
	{
		id: 1,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "HB",
		quantity: 1,
		tot_stem_flower: 300,
		tot_cost_price_box: 0.36,
		profit_margin: 38,
		varieties: [
			{
				id: 1,
				product_name: "ROSA VERIFICAR CARRIOUSEL",
				length: 50,
				qty_stem_flower: 300,
				stem_cost_price: 0.3,
				total_bunches: 0,
				stems_bunch: 0,
				color: "NO DEFINIDO"
			}
		]
	},
	{
		id: 2,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "HB",
		quantity: 1,
		tot_stem_flower: 300,
		tot_cost_price_box: 0.36,
		profit_margin: 36,
		varieties: [
			{
				id: 2,
				product_name: "ROSA DEEP PURPLE",
				length: 50,
				qty_stem_flower: 300,
				stem_cost_price: 0.3,
				total_bunches: 0,
				stems_bunch: 0,
				color: "LAVANDER"
			}
		]
	},
	{
		id: 3,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "HB",
		quantity: 1,
		tot_stem_flower: 300,
		tot_cost_price_box: 0.66,
		profit_margin: 66,
		varieties: [
			{
				id: 3,
				product_name: "ROSA GOTCHA",
				length: 70,
				qty_stem_flower: 300,
				stem_cost_price: 0.6,
				total_bunches: 0,
				stems_bunch: 0,
				color: "BICOLOR"
			}
		]
	},
	{
		id: 4,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "HB",
		quantity: 2,
		tot_stem_flower: 600,
		tot_cost_price_box: 0.41,
		profit_margin: 41,
		varieties: [
			{
				id: 4,
				product_name: "ROSA LOLA",
				length: 80,
				qty_stem_flower: 600,
				stem_cost_price: 0.35,
				total_bunches: 0,
				stems_bunch: 0,
				color: "HOT PINK"
			}
		]
	},
	{
		id: 5,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "HB",
		quantity: 3,
		tot_stem_flower: 900,
		tot_cost_price_box: 0.51,
		profit_margin: 51,
		varieties: [
			{
				id: 5,
				product_name: "ROSA ORANGE CRUSH",
				length: 60,
				qty_stem_flower: 900,
				stem_cost_price: 0.45,
				total_bunches: 0,
				stems_bunch: 0,
				color: "ORANGE"
			}
		]
	},
	{
		id: 6,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "HB",
		quantity: 1,
		tot_stem_flower: 300,
		tot_cost_price_box: 0.46,
		profit_margin: 46,
		varieties: [
			{
				id: 6,
				product_name: "ROSA VERIFICAR MOODY BLUES",
				length: 50,
				qty_stem_flower: 300,
				stem_cost_price: 0.4,
				total_bunches: 0,
				stems_bunch: 0,
				color: "LAVANDER"
			}
		]
	},
	{
		id: 7,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "QB",
		quantity: 2,
		tot_stem_flower: 200,
		tot_cost_price_box: 0.31,
		profit_margin: 31,
		varieties: [
			{
				id: 7,
				product_name: "ROSA AMSTERDAM",
				length: 40,
				qty_stem_flower: 200,
				stem_cost_price: 0.25,
				total_bunches: 0,
				stems_bunch: 0,
				color: "WHITE AND CREAM"
			}
		]
	},
	{
		id: 8,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "QB",
		quantity: 1,
		tot_stem_flower: 100,
		tot_cost_price_box: 0.66,
		profit_margin: 66,
		varieties: [
			{
				id: 8,
				product_name: "ROSA BRIGHTON",
				length: 80,
				qty_stem_flower: 100,
				stem_cost_price: 0.6,
				total_bunches: 0,
				stems_bunch: 0,
				color: "YELLOWS"
			}
		]
	},
	{
		id: 9,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "HB",
		quantity: 1,
		tot_stem_flower: 300,
		tot_cost_price_box: 0.36,
		profit_margin: 36,
		varieties: [
			{
				id: 9,
				product_name: "ROSA PINK FLOYD",
				length: 50,
				qty_stem_flower: 300,
				stem_cost_price: 0.3,
				total_bunches: 0,
				stems_bunch: 0,
				color: "HOT PINK"
			}
		]
	},
	{
		id: 10,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "HB",
		quantity: 2,
		tot_stem_flower: 600,
		tot_cost_price_box: 0.46,
		profit_margin: 46,
		varieties: [
			{
				id: 10,
				product_name: "ROSA VERIFICAR MOODY BLUES",
				length: 70,
				qty_stem_flower: 600,
				stem_cost_price: 0.4,
				total_bunches: 0,
				stems_bunch: 0,
				color: "LAVANDER"
			}
		]
	},
	{
		id: 11,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "HB",
		quantity: 1,
		tot_stem_flower: 300,
		tot_cost_price_box: 0.51,
		profit_margin: 51,
		varieties: [
			{
				id: 11,
				product_name: "ROSA PLAYA BLANCA",
				length: 60,
				qty_stem_flower: 300,
				stem_cost_price: 0.45,
				total_bunches: 0,
				stems_bunch: 0,
				color: "WHITE AND CREAM"
			}
		]
	},
	{
		id: 12,
		partner_name: "SANTA CLARA GARDENS",
		partner_short_name: "STC",
		box_model: "QB",
		quantity: 1,
		tot_stem_flower: 100,
		tot_cost_price_box: 0.46,
		profit_margin: 46,
		varieties: [
			{
				id: 12,
				product_name: "ROSA BRIGHTON",
				length: 70,
				qty_stem_flower: 100,
				stem_cost_price: 0.4,
				total_bunches: 0,
				stems_bunch: 0,
				color: "SAND"
			}
		]
	}
];

let filteredData = [...stockData];
let currentPage = 1;
const itemsPerPage = 10;
let customers = [];
let preselectedData = null;
let selectedItems = []; // Array para items seleccionados
let activeFilters = {
	providers: [],
	colors: [],
	lengths: [],
	boxModels: []
};

// Inicializar la aplicación
document.addEventListener('DOMContentLoaded', function() {
	setupEventListeners();
	initializeFilters();
	renderTable();
	updateSummary();
	loadCustomers();
});

function setupEventListeners() {
	const searchInput = document.getElementById('searchInput');
	const orderForm = document.getElementById('orderForm');
	
	searchInput.addEventListener('input', debounce(filterData, 300));
	orderForm.addEventListener('submit', handleOrderSubmit);
}

function debounce(func, wait) {
	let timeout;
	return function executedFunction(...args) {
		const later = () => {
			clearTimeout(timeout);
			func(...args);
		};
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
	};
}

function toggleFilters() {
	const filterPanel = document.getElementById('filterPanel');
	filterPanel.classList.toggle('hidden');
}

function initializeFilters() {
	// Obtener valores únicos de los datos
	const providers = [...new Set(stockData.map(item => item.partner_short_name))];
	const colors = [...new Set(stockData.flatMap(item => item.varieties.map(v => v.color)))];
	const lengths = [...new Set(stockData.flatMap(item => item.varieties.map(v => v.length)))].sort((a, b) => a - b);
	const boxModels = [...new Set(stockData.map(item => item.box_model))];
	
	// Inicializar filtros activos (todos seleccionados por defecto)
	activeFilters.providers = providers;
	activeFilters.colors = colors;
	activeFilters.lengths = lengths;
	activeFilters.boxModels = boxModels;
}

async function loadCustomers() {
	try {
		const response = await fetch('/sellers/api/customers/');
		const data = await response.json();
		
		if (data.success) {
			customers = data.customers;
			populateCustomerSelect();
		}
	} catch (error) {
		console.error('Error loading customers:', error);
	}
}

function populateCustomerSelect() {
	const select = document.querySelector('#orderForm select');
	const defaultOption = select.querySelector('option[value=""]');
	
	// Limpiar opciones excepto la primera
	select.innerHTML = '';
	select.appendChild(defaultOption);
	
	// Agregar clientes
	customers.forEach(customer => {
		const option = document.createElement('option');
		option.value = customer.id;
		option.textContent = customer.short_name || customer.name;
		select.appendChild(option);
	});
}

function filterData() {
	const searchTerm = document.getElementById('searchInput').value.toLowerCase();
	
	filteredData = stockData.filter(item => {
		// Filtro de búsqueda por texto
		const matchesSearch = !searchTerm.trim() || (
			item.partner_name.toLowerCase().includes(searchTerm) ||
			item.partner_short_name.toLowerCase().includes(searchTerm) ||
			item.box_model.toLowerCase().includes(searchTerm) ||
			item.varieties.some(variety => 
				variety.product_name.toLowerCase().includes(searchTerm) ||
				variety.color.toLowerCase().includes(searchTerm)
			)
		);
		
		// Filtros por checkboxes
		const matchesProvider = activeFilters.providers.length === 0 || 
			activeFilters.providers.includes(item.partner_short_name);
		
		const matchesBoxModel = activeFilters.boxModels.length === 0 || 
			activeFilters.boxModels.includes(item.box_model);
		
		const matchesColor = activeFilters.colors.length === 0 || 
			item.varieties.some(v => activeFilters.colors.includes(v.color));
		
		const matchesLength = activeFilters.lengths.length === 0 || 
			item.varieties.some(v => activeFilters.lengths.includes(v.length));
		
		return matchesSearch && matchesProvider && matchesBoxModel && matchesColor && matchesLength;
	});
	
	currentPage = 1;
	renderTable();
	updateSummary();
}

function applyFilters() {
	// Recolectar filtros seleccionados
	activeFilters.providers = Array.from(document.querySelectorAll('#providerFilters input:checked')).map(cb => cb.value);
	activeFilters.colors = Array.from(document.querySelectorAll('#colorFilters input:checked')).map(cb => cb.value);
	activeFilters.lengths = Array.from(document.querySelectorAll('#lengthFilters input:checked')).map(cb => parseInt(cb.value));
	activeFilters.boxModels = Array.from(document.querySelectorAll('#boxModelFilters input:checked')).map(cb => cb.value);
	
	filterData();
	toggleFilters();
}

function clearAllFilters() {
	// Marcar todos los checkboxes
	document.querySelectorAll('#providerFilters input, #colorFilters input, #lengthFilters input, #boxModelFilters input').forEach(cb => {
		cb.checked = true;
	});
	
	// Reiniciar filtros activos
	const providers = [...new Set(stockData.map(item => item.partner_short_name))];
	const colors = [...new Set(stockData.flatMap(item => item.varieties.map(v => v.color)))];
	const lengths = [...new Set(stockData.flatMap(item => item.varieties.map(v => v.length)))];
	const boxModels = [...new Set(stockData.map(item => item.box_model))];
	
	activeFilters.providers = providers;
	activeFilters.colors = colors;
	activeFilters.lengths = lengths;
	activeFilters.boxModels = boxModels;
	
	document.getElementById('searchInput').value = '';
	filterData();
}

function deselectAllProviders() {
	document.querySelectorAll('#providerFilters input').forEach(cb => cb.checked = false);
}

function deselectAllColors() {
	document.querySelectorAll('#colorFilters input').forEach(cb => cb.checked = false);
}

function deselectAllLengths() {
	document.querySelectorAll('#lengthFilters input').forEach(cb => cb.checked = false);
}

function deselectAllBoxModels() {
	document.querySelectorAll('#boxModelFilters input').forEach(cb => cb.checked = false);
}

function renderTable() {
	const tableContainer = document.getElementById('stockTable');
	const startIndex = (currentPage - 1) * itemsPerPage;
	const endIndex = startIndex + itemsPerPage;
	const pageData = filteredData.slice(startIndex, endIndex);
	
	if (pageData.length === 0) {
		tableContainer.innerHTML = `
			<div class="text-center py-8 text-gray-500 bg-base-100 rounded-lg border border-base-200">me gusra 
				<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
				</svg>
				<p class="text-sm">No se encontraron resultados</p>
			</div>
		`;
		renderPagination();
		return;
	}
	
	// Generar filas de tabla (una fila por variedad)
	let rows = '';
	pageData.forEach(item => {
		item.varieties.forEach(variety => {
			const isSelected = selectedItems.some(sel => sel.varietyId === variety.id && sel.stockId === item.id);
			rows += `
				<tr class="hover:bg-base-200 ${isSelected ? 'bg-primary/10' : ''}">
					<td class="text-center">
						<span class="font-medium">${item.quantity}</span> 
						<span class="badge badge-xs badge-ghost">${item.box_model}</span>
					</td>
					<td>
						<div class="text-xs font-medium">${variety.product_name}</div>
						<div class="text-[10px] opacity-60">${item.partner_short_name}</div>
					</td>
					<td class="text-center">
						<span class="badge badge-sm badge-primary">${variety.length}</span>
					</td>
					<td class="text-center">
						<input 
							type="checkbox" 
							class="checkbox checkbox-sm checkbox-primary" 
							${isSelected ? 'checked' : ''}
							onchange="toggleItemSelection(${item.id}, ${variety.id}, '${variety.product_name}', ${variety.length}, ${item.quantity}, '${item.box_model}', '${item.partner_short_name}', ${variety.qty_stem_flower})"
						>
					</td>
				</tr>
			`;
		});
	});
	
	const html = `
		<div class="overflow-x-auto bg-base-100 rounded-lg border border-base-200">
			<table class="table table-xs table-pin-rows">
				<thead>
					<tr class="bg-base-200">
						<th class="text-center">Cant</th>
						<th>Variedad</th>
						<th class="text-center">Largo</th>
						<th class="text-center">Sel</th>
					</tr>
				</thead>
				<tbody>
					${rows}
				</tbody>
			</table>
		</div>
	`;
	
	tableContainer.innerHTML = html;
	renderPagination();
}

function renderPagination() {
	const totalPages = Math.ceil(filteredData.length / itemsPerPage);
	const pagination = document.getElementById('pagination');
	
	document.getElementById('totalPagesDisplay').textContent = totalPages;
	
	if (totalPages <= 1) {
		pagination.innerHTML = '';
		return;
	}
	
	let html = '';
	
	// Botón anterior
	if (currentPage > 1) {
		html += `<button class="join-item btn btn-sm" onclick="changePage(${currentPage - 1})">❮</button>`;
	}
	
	// Números de página (mostrar menos en móvil)
	const startPage = Math.max(1, currentPage - 1);
	const endPage = Math.min(totalPages, currentPage + 1);
	
	if (startPage > 1) {
		html += `<button class="join-item btn btn-sm" onclick="changePage(1)">1</button>`;
		if (startPage > 2) {
			html += `<button class="join-item btn btn-sm btn-disabled">...</button>`;
		}
	}
	
	for (let i = startPage; i <= endPage; i++) {
		const activeClass = i === currentPage ? 'btn-active' : '';
		html += `<button class="join-item btn btn-sm ${activeClass}" onclick="changePage(${i})">${i}</button>`;
	}
	
	if (endPage < totalPages) {
		if (endPage < totalPages - 1) {
			html += `<button class="join-item btn btn-sm btn-disabled">...</button>`;
		}
		html += `<button class="join-item btn btn-sm" onclick="changePage(${totalPages})">${totalPages}</button>`;
	}
	
	// Botón siguiente
	if (currentPage < totalPages) {
		html += `<button class="join-item btn btn-sm" onclick="changePage(${currentPage + 1})">❯</button>`;
	}
	
	pagination.innerHTML = html;
}

function changePage(page) {
	currentPage = page;
	renderTable();
}

function updateSummary() {
	// Función mantenida para compatibilidad pero ya no actualiza elementos visuales
}

// Función para alternar selección de item
function toggleItemSelection(stockId, varietyId, productName, length, quantity, boxModel, partnerName, totalStems) {
	const index = selectedItems.findIndex(item => item.varietyId === varietyId && item.stockId === stockId);
	
	if (index > -1) {
		// Remover item
		selectedItems.splice(index, 1);
	} else {
		// Agregar item
		selectedItems.push({
			stockId,
			varietyId,
			productName,
			length,
			quantity,
			boxModel,
			partnerName,
			totalStems
		});
	}
	
	updateSelectedCount();
	renderTable(); // Re-renderizar para actualizar el estado visual
}

// Actualizar contador de items seleccionados
function updateSelectedCount() {
	const count = selectedItems.length;
	document.getElementById('selectedCount').textContent = count;
	
	const createOrderBtn = document.getElementById('createOrderBtn');
	if (count > 0) {
		createOrderBtn.classList.remove('hidden');
	} else {
		createOrderBtn.classList.add('hidden');
	}
}

// Mostrar modal con resumen de orden
function showOrderSummary() {
	if (selectedItems.length === 0) {
		showAlert('warning', 'Selecciona al menos un item');
		return;
	}
	
	// Actualizar contador en modal
	document.getElementById('modalSelectedCount').textContent = selectedItems.length;
	
	// Generar lista de items
	const listHtml = selectedItems.map((item, index) => `
		<tr>
			<td>${item.quantity} ${item.boxModel}</td>
			<td>
				<div class="text-xs">${item.productName}</div>
				<div class="text-[10px] opacity-60">${item.partnerName}</div>
			</td>
			<td><span class="badge badge-xs badge-primary">${item.length}</span></td>
			<td>${item.totalStems}</td>
			<td>
				<button 
					type="button"
					onclick="removeFromSelection(${index})" 
					class="btn btn-xs btn-circle btn-ghost text-error"
				>
					<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
					</svg>
				</button>
			</td>
		</tr>
	`).join('');
	
	document.getElementById('selectedItemsList').innerHTML = listHtml;
	
	// Abrir modal
	document.getElementById('orderSummaryModal').classList.add('modal-open');
}

// Remover item de la selección desde el modal
function removeFromSelection(index) {
	selectedItems.splice(index, 1);
	updateSelectedCount();
	
	if (selectedItems.length === 0) {
		closeOrderSummaryModal();
	} else {
		showOrderSummary(); // Refrescar modal
	}
	
	renderTable(); // Actualizar tabla
}

// Cerrar modal de resumen
function closeOrderSummaryModal() {
	document.getElementById('orderSummaryModal').classList.remove('modal-open');
}

function addToOrder(id, type) {
	// Preparar datos preseleccionados
	const preselectedDiv = document.getElementById('preselectedStock');
	const preselectedInfo = document.getElementById('preselectedInfo');
	
	if (type === 'stock') {
		const item = stockData.find(s => s.id === id);
		preselectedInfo.textContent = `Stock completo: ${item.partner_name} - ${item.box_model} (${item.quantity} cajas)`;
		preselectedData = { type: 'stock', id: id, item: item };
	} else {
		// Encontrar la variedad
		let variety = null;
		let parentStock = null;
		for (const stock of stockData) {
			variety = stock.varieties.find(v => v.id === id);
			if (variety) {
				parentStock = stock;
				break;
			}
		}
		preselectedInfo.textContent = `Variedad: ${variety.product_name} - ${variety.length}cm`;
		preselectedData = { type: 'variety', id: id, variety: variety, stock: parentStock };
	}
	
	preselectedDiv.classList.remove('hidden');
	openOrderModal();
}

async function handleOrderSubmit(e) {
	e.preventDefault();
	
	if (selectedItems.length === 0) {
		showAlert('warning', 'Selecciona al menos un item');
		return;
	}
	
	const formData = new FormData(e.target);
	const submitButton = e.target.querySelector('button[type="submit"]');
	
	// Deshabilitar botón
	submitButton.disabled = true;
	submitButton.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Creando...';
	
	try {
		const orderData = {
			customer_id: formData.get('customer'),
			po_customer: formData.get('po_customer'),
			delivery_date: formData.get('delivery_date'),
			discount_percent: formData.get('discount_percent'),
			selected_items: selectedItems // Enviar items seleccionados
		};
		
		const response = await fetch('/sellers/api/orders/create/', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': getCookie('csrftoken')
			},
			body: JSON.stringify(orderData)
		});
		
		const result = await response.json();
		
		if (result.success) {
			// Limpiar selección
			selectedItems = [];
			updateSelectedCount();
			
			// Mostrar mensaje de éxito
			showAlert('success', result.message || 'Orden creada exitosamente');
			closeOrderSummaryModal();
			
			// Opcional: redirigir a la orden creada
			if (result.order_id) {
				setTimeout(() => {
					window.location.href = `/sellers/orders/${result.order_id}/edit/`;
				}, 1500);
			}
		} else {
			showAlert('error', result.error || 'Error al crear la orden');
		}
		
	} catch (error) {
		console.error('Error:', error);
		showAlert('error', 'Error de conexión');
	} finally {
		// Rehabilitar botón
		submitButton.disabled = false;
		submitButton.innerHTML = 'Crear Orden de Venta';
	}
}

function getCookie(name) {
	let cookieValue = null;
	if (document.cookie && document.cookie !== '') {
		const cookies = document.cookie.split(';');
		for (let i = 0; i < cookies.length; i++) {
			const cookie = cookies[i].trim();
			if (cookie.substring(0, name.length + 1) === (name + '=')) {
				cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
				break;
			}
		}
	}
	return cookieValue;
}

function showAlert(type, message) {
	const alertDiv = document.createElement('div');
	alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'error'} fixed top-4 right-4 w-80 z-50`;
	alertDiv.innerHTML = `
		<i class="la la-${type === 'success' ? 'check' : 'exclamation'}-circle"></i>
		<span>${message}</span>
	`;
	
	document.body.appendChild(alertDiv);
	
	setTimeout(() => {
		alertDiv.remove();
	}, 3000);
}

function openOrderModal() {
	document.getElementById('orderModal').classList.add('modal-open');
}

function closeOrderModal() {
	document.getElementById('orderModal').classList.remove('modal-open');
	preselectedData = null;
}

// Cerrar modales al hacer clic fuera
document.getElementById('orderSummaryModal').addEventListener('click', function(e) {
	if (e.target === this) {
		closeOrderSummaryModal();
	}
});

document.getElementById('orderModal').addEventListener('click', function(e) {
	if (e.target === this) {
		closeOrderModal();
	}
});
</script>
{% endblock %}