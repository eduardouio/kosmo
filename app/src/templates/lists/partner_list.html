{% extends 'base/base.html' %}
{% block content %}
<div class="container-fluid mx-auto mt-3 mb-3 border shadow rounded bg-opacity-50 m-2 p-1">
    <div class="d-flex justify-content-between">
        <div class="d-flex align-items-center gap-3">
            {% if action %}
            <span class="bg-kosmo-green bg-gradient p-2 rounded">
                <i class="la la-check-circle me-1"></i>
                {{ message }}
            </span>
            {% endif %}
            <div class="d-flex gap-2">
                <button id="exportExcel" class="btn btn-success btn-sm" title="Exportar a Excel">
                    <i class="la la-file-excel me-1"></i>
                    Excel
                </button>
                <button id="exportPDF" class="btn btn-danger btn-sm" title="Exportar a PDF">
                    <i class="la la-file-pdf me-1"></i>
                    PDF
                </button>
            </div>
        </div>
        <a href="{% url 'partner_create' %}" class="btn btn-sm btn-default">
            <i class="la la-plus me-1"></i>
            {% if source_page == 'clientes' %}
                Nuevo Cliente
            {% else %}
                Nuevo Proveedor
            {% endif %}
        </a>
    </div>
</div>

<div class="mx-auto list-container">
    {% if object_list %}
    <div class="mb-3">
        <small class="text-muted">
            <i class="la la-chart-line me-1"></i>
            {% if source_page == 'clientes' %}
                Estadísticas de ventas por cliente
            {% else %}
                Estadísticas de compras por proveedor
            {% endif %}
        </small>
    </div>
    
    <table class="table table-bordered table-striped table-sm list-table" id="partnerTable">
        <thead>
            <tr>
                <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 60px;">#</th>
                <th class="bg-secondary bg-opacity-25 p-1" style="width: 220px;">Nombre</th>
                <th class="bg-secondary bg-opacity-25 p-1" style="width: 180px;">Correo Electrónico</th>
                <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 80px;">País</th>
                <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 80px;">Crédito</th>
                {% if source_page == 'clientes' %}
                    <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 100px;">
                        <small>Total Ventas<br>($)</small>
                    </th>
                    <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 90px;">
                        <small>Tallos<br>Vendidos</small>
                    </th>
                    <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 90px;">
                        <small>Pedidos<br>Pendientes</small>
                    </th>
                    <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 120px;">Vendedor</th>
                {% else %}
                    <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 100px;">
                        <small>Total Compras<br>($)</small>
                    </th>
                    <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 90px;">
                        <small>Tallos<br>Comprados</small>
                    </th>
                    <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 90px;">
                        <small>Pedidos<br>Pendientes</small>
                    </th>
                {% endif %}
                {% if source_page == 'proveedores' %}
                <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 80px;">Prompt</th>
                {% else %}
                <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 80px;">Estado</th>
                {% endif %}
                <th class="bg-secondary bg-opacity-25 text-center p-1" style="width: 80px;">
                    <i class="la la-tools me-1" title="Acciones"></i>Acciones
                </th>
            </tr>
        </thead>
        <tbody>
            {% for item in object_list %}
            <tr>
                <td class="text-center align-middle" style="padding: 6px;">
                    <a href="{% url 'partner_detail' item.id %}" class="text-primary fw-bold text-decoration-none">
                        {{ item.id }}
                    </a>
                </td>
                <td class="align-middle" style="padding: 6px;">
                    <a href="{% url 'partner_detail' item.id %}" class="text-dark text-decoration-none fw-semibold">
                        {% if source_page == 'clientes' %}
                            <i class="la la-user-tie text-primary me-1" title="Cliente"></i>
                        {% else %}
                            <i class="la la-industry text-secondary me-1" title="Proveedor"></i>
                        {% endif %}
                        {% if item.is_active %}
                            <i class="la la-check-circle text-success me-1" title="Activo"></i>
                        {% else %}
                            <i class="la la-exclamation-circle text-warning me-1" title="Inactivo"></i>
                        {% endif %}
                        <span>{{ item.name }}</span>
                    </a>
                </td>
                <td class="align-middle" style="padding: 6px;">
                    {% if item.email %}
                        <span class="text-muted">{{ item.email }}</span>
                    {% else %}
                        <span class="text-muted">--</span>
                    {% endif %}
                </td>
                <td class="text-center align-middle" style="padding: 6px;">
                    <span class="badge bg-info text-dark">{{ item.country|default:"--" }}</span>
                </td>
                <td class="text-center align-middle" style="padding: 6px;">
                    {% if item.credit_term %}
                        <span class="badge bg-warning text-dark">{{ item.credit_term }}d</span>
                    {% else %}
                        <span class="badge bg-secondary">Contado</span>
                    {% endif %}
                </td>
                <td class="text-center align-middle" style="padding: 6px;">
                    {% if item.total_invoice_amount and item.total_invoice_amount > 0 %}
                        <span class="badge bg-success">${{ item.total_invoice_amount|floatformat:2 }}</span>
                    {% else %}
                        <span class="text-muted">$0.00</span>
                    {% endif %}
                </td>
                <td class="text-center align-middle" style="padding: 6px;">
                    {% if item.total_stems_sold and item.total_stems_sold > 0 %}
                        <span class="badge bg-primary">{{ item.total_stems_sold|floatformat:0 }}</span>
                    {% else %}
                        <span class="text-muted">0</span>
                    {% endif %}
                </td>
                <td class="text-center align-middle" style="padding: 6px;">
                    {% if item.pending_orders and item.pending_orders > 0 %}
                        <span class="badge bg-warning text-dark">{{ item.pending_orders }}</span>
                    {% else %}
                        <span class="text-muted">0</span>
                    {% endif %}
                </td>
                {% if source_page == 'clientes' %}
                <td class="text-center align-middle" style="padding: 6px;">
                    {% if item.seller %}
                        <span class="text-dark fw-semibold">{{ item.seller }}</span>
                    {% else %}
                        <span class="text-muted">Sin asignar</span>
                    {% endif %}
                </td>
                {% endif %}
                {% if source_page == 'proveedores' %}
                <td class="text-center align-middle" style="padding: 6px;">
                    {% if item.prompt_disponibility %}
                        <span class="badge bg-primary" title="Prompt personalizado definido">PERSONALIZADO</span>
                    {% else %}
                        <span class="badge bg-secondary" title="Usa prompt por defecto del sistema">DEFECTO</span>
                    {% endif %}
                </td>
                {% else %}
                <td class="text-center align-middle" style="padding: 6px;">
                    <div class="d-flex justify-content-center gap-1">
                        {% if item.is_verified %}
                            <i class="la la-check-circle text-success" title="Verificado"></i>
                        {% else %}
                            <i class="la la-times-circle text-danger" title="No verificado"></i>
                        {% endif %}
                        {% if item.is_active %}
                            <i class="la la-user-check text-success" title="Activo"></i>
                        {% else %}
                            <i class="la la-user-times text-danger" title="Inactivo"></i>
                        {% endif %}
                    </div>
                </td>
                {% endif %}
                <td class="text-center align-middle" style="padding: 6px;">
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'partner_update' item.id %}" class="btn btn-outline-primary btn-sm" title="Editar">
                            <i class="la la-edit"></i>
                        </a>
                        <a href="{% url 'partner_detail' item.id %}" class="btn btn-outline-info btn-sm" title="Ver detalles">
                            <i class="la la-eye"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% else %}
    <!-- Mensaje cuando no hay datos -->
    <div class="alert alert-info text-center">
    <i class="la la-info-circle me-2"></i>
        {% if source_page == 'clientes' %}
            No hay clientes registrados en el sistema.
        {% else %}
            No hay proveedores registrados en el sistema.
        {% endif %}
        <br>
        <a href="{% url 'partner_create' %}" class="btn btn-primary btn-sm mt-2">
            Crear el primer {{ source_page|slice:":-1" }}
        </a>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block style %}
<style>
/* Estilos mejorados para la tabla de partners */
.table-sm td {
    padding: 0.25rem !important;
    vertical-align: middle;
    /* Eliminé font-size para mantener tamaño normal */
}

.table-sm th {
    padding: 0.4rem !important;
    /* Eliminé font-size para mantener tamaño normal */
    font-weight: 600;
    line-height: 1.2;
}

.badge {
    font-size: 0.75rem; /* Aumenté ligeramente el tamaño de los badges */
    padding: 0.35em 0.6em;
}

/* Hover effects para las filas */
tbody tr:hover {
    background-color: #f8fafc !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

/* Enlaces más atractivos */
a.text-decoration-none:hover {
    text-decoration: underline !important;
    color: #0d6efd !important;
}

/* Mejorar la apariencia de los badges */
.badge.bg-info {
    background-color: #e3f2fd !important;
    color: #1976d2 !important;
    border: 1px solid #bbdefb;
}

.badge.bg-success {
    background-color: #e8f5e8 !important;
    color: #2e7d32 !important;
    border: 1px solid #c8e6c9;
}

.badge.bg-primary {
    background-color: #3b82f6 !important;
    color: white !important;
}

.badge.bg-warning {
    background-color: #f59e0b !important;
    color: #1f2937 !important;
}

.badge.bg-secondary {
    background-color: #6b7280 !important;
    color: white !important;
}

/* Iconos de estado */
.icon-tabler {
    display: inline-block;
    vertical-align: middle;
}

/* Responsividad mejorada */
@media (max-width: 1200px) {
    .mx-auto {
        width: 100% !important;
        padding: 0 5px;
    }
    
    .table-sm td, .table-sm th {
        padding: 0.2rem !important;
        /* Mantengo font-size normal en responsive también */
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.3em 0.5em;
    }
}

/* Tooltip para iconos */
[title] {
    cursor: help;
}
</style>
{% endblock %}

{% block script %}
<!-- Librerías para exportación -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar DataTable para partners
    $('#partnerTable').DataTable({
        "pageLength": 15,
        "lengthMenu": [15, 25, 50, 100, 500, 1000, 5000],
        "language": {
            "lengthMenu": "_MENU_ registros por página",
            "zeroRecords": "Sin registros",
            "info": "Mostrando página _PAGE_ de _PAGES_",
            "infoEmpty": "Sin registros",
            "infoFiltered": "(filtrado de _MAX_ registros totales)",
            "search": "Buscar:",
            "paginate": {
                "first": "Primero",
                "last": "Último",
                "next": "Siguiente",
                "previous": "Anterior"
            }
        },
        "columnDefs": [
            {
                "orderable": true,
                "targets": "_all"
            }
        ]
    });
    
    // Funcionalidad de exportación Excel
    $('#exportExcel').off('click').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var table = $('#partnerTable')[0];
        var wb = XLSX.utils.book_new();
        var ws = XLSX.utils.table_to_sheet(table);
        XLSX.utils.book_append_sheet(wb, ws, "Partners");
        var fecha = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, "partners_" + fecha + ".xlsx");
    });
    
    // Funcionalidad de exportación PDF
    $('#exportPDF').off('click').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const { jsPDF } = window.jspdf;
        var doc = new jsPDF('l', 'pt', 'a4');
        
        // Crear imagen del logo
        var logoImg = new Image();
        logoImg.crossOrigin = 'anonymous';
        logoImg.onload = function() {
            // Agregar logo (ajustar tamaño proporcional)
            var logoWidth = 80;
            var logoHeight = (logoImg.height * logoWidth) / logoImg.width;
            doc.addImage(logoImg, 'PNG', 20, 20, logoWidth, logoHeight);
            
            // Agregar texto junto al logo
            doc.setFontSize(16);
            doc.text('Kosmo Flowers', 110, 35);
            doc.setFontSize(12);
            doc.text('Listado de Partners', 110, 55);
            var fecha = new Date().toLocaleDateString('es-ES');
            doc.setFontSize(10);
            doc.text('Generado el: ' + fecha, 110, 75);
            
            // Generar tabla
            var table = $('#partnerTable')[0];
            var headers = [];
            var data = [];
            
            $(table).find('thead tr th').each(function() {
                headers.push($(this).text().trim());
            });
            
            $(table).find('tbody tr').each(function() {
                var row = [];
                $(this).find('td').each(function() {
                    var cellText = $(this).text().trim().replace(/\s+/g, ' ');
                    row.push(cellText);
                });
                data.push(row);
            });
            
            doc.autoTable({
                head: [headers],
                body: data,
                startY: 100,
                styles: { fontSize: 6, cellPadding: 2 },
                headStyles: { fillColor: [52, 58, 64], textColor: 255, fontSize: 7, fontStyle: 'bold' },
                margin: { top: 100, left: 15, right: 15 },
            });
            
            var fechaArchivo = new Date().toISOString().slice(0,10);
            doc.save("partners_" + fechaArchivo + ".pdf");
        };
        
        // Cargar logo desde la ruta del servidor
        logoImg.src = '/static/img/logo-kosmo.png';
    });
});
</script>
{% endblock %}