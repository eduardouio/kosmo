{% extends 'base/base.html' %}
{% load static %}

{% block files_header %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block style %}
<style>
      /* Estilos específicos para el estado de cuenta */
      .account-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
      }
      .account-logo {
        max-width: 200px;
      }
      .account-title {
        text-align: right;
        color: #007bff;
        font-weight: bold;
      }
      .company-info {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }
      .company-info-left,
      .company-info-right {
        font-size: 14px;
      }
      .company-info-right {
        text-align: right;
      }
      .filters-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #e5e7eb;
      }
      .filters-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr auto auto;
        gap: 15px;
        align-items: end;
      }
      .form-group {
        display: flex;
        flex-direction: column;
      }
      .form-label {
        font-weight: bold;
        color: #6b7280;
        margin-bottom: 5px;
        font-size: 0.9em;
      }
      .form-control {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        font-size: 14px;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background-color: #0056b3;
      }
      .btn-outline-secondary {
        background-color: white;
        color: #495057;
        border: 1px solid #ced4da;
      }
      .btn-outline-success {
        background-color: white;
        color: #28a745;
        border: 1px solid #28a745;
      }
      .section-title {
        color: #007bff;
        font-size: 1.1em;
        margin: 15px 0 10px 0;
        border-bottom: 1px solid #007bff;
        padding-bottom: 5px;
      }
      .partner-info-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
        padding: 20px;
        border: 2px solid #007bff;
        border-radius: 16px;
      }
      .partner-details {
        font-size: 14px;
      }
      .account-summary {
        background-color: #f8f9fa;
        border: 1px solid #007bff;
        border-radius: 8px;
        overflow: hidden;
      }
      .account-summary-header {
        background-color: #007bff;
        color: white;
        text-align: center;
        padding: 8px;
        font-weight: bold;
      }
      .account-summary-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        border-bottom: 1px solid #e5e7eb;
      }
      .account-summary-row:last-child {
        border-bottom: none;
      }
      .account-summary-label {
        padding: 8px;
        font-weight: bold;
        background-color: #f8f9fa;
      }
      .account-summary-value {
        padding: 8px;
        text-align: center;
      }
      /* Estilos para la tabla de movimientos */
      .table-responsive {
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      
      .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
      }
      
      .payment-row {
        background-color: #ffe6e6 !important;
        color: #dc3545 !important;
      }
      
      .payment-row td {
        color: #dc3545 !important;
        font-weight: 500;
      }
      
      /* Estilos para facturas vencidas */
      .invoice-overdue {
        background-color: #ffe6e6 !important;
        color: #dc3545 !important;
      }
      
      .invoice-overdue td {
        color: #dc3545 !important;
        font-weight: 500;
      }
      
      .overdue-text {
        color: #dc3545 !important;
        font-weight: bold;
      }
      .text-end {
        text-align: right;
      }
      .text-center {
        text-align: center;
      }
      .text-danger {
        color: #dc3545;
      }
      .text-success {
        color: #28a745;
      }
      .text-muted {
        color: #495057;
      }
      .alert {
        padding: 12px 20px;
        margin-bottom: 20px;
        border-radius: 4px;
      }
      .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .alert-danger {
        background-color: #f8d7da;
        color: #dc3545;
        border: 1px solid #f5c6cb;
      }
      /* Estilos para el autocomplete */
      .partner-search-container {
        position: relative;
      }
      .partner-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }
      .partner-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
      }
      .partner-suggestion:hover {
        background-color: #f8f9fa;
      }
      .partner-suggestion:last-child {
        border-bottom: none;
      }
    </style>
{% endblock %}
{% block content %}
    <div class="container">

      <!-- Filtros -->
      <div class="filters-section">
        <h2 class="section-title">Estado de Cuenta</h2>
        <form method="get">
          <div class="filters-grid">
            <div class="form-group partner-search-container">
              <label class="form-label">Cliente/Proveedor</label>
              <input type="hidden" name="partner_id" id="partnerIdInput" value="{{ request.GET.partner_id }}">
              <input type="text" id="partnerSearch" class="form-control" placeholder="Buscar cliente o proveedor..." autocomplete="off" value="{% if partner %}{{ partner.name }}{% endif %}">
              <div id="partnerSuggestions" class="partner-suggestions"></div>
            </div>
            <div class="form-group">
              <label class="form-label">Desde</label>
              <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
            </div>
            <div class="form-group">
              <label class="form-label">Hasta</label>
              <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
            </div>
            <button class="btn btn-primary">Filtrar</button>
            {% if partner %}
            <a class="btn btn-outline-secondary" href="{% url 'balance_pdf' partner_id=partner.id %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}" target="_blank">PDF</a>
            {% endif %}
          </div>
        </form>
      </div>      <!-- Mensajes de estado -->
      {% if missing_partner %}
        <div class="alert alert-info">Seleccione un cliente o proveedor para ver el estado de cuenta.</div>
      {% elif partner_not_found %}
        <div class="alert alert-danger">Cliente o proveedor no encontrado.</div>
      {% else %}

      <!-- Información del partner -->
      <div class="partner-info-container">
        <div class="partner-details">
          <h2 class="section-title">Información del {{ partner.type_partner }}</h2>
          <div><strong>{{ partner.name|upper }}</strong></div>
          <div>City/Country: {{ partner.city|upper }} / {{ partner.country|upper }}</div>
          <div>E-mail: {{ partner.email }}</div>
          <div>Tax ID: {{ partner.business_tax_id }}</div>
          <div>Crédito: {{ partner.credit_term }} días</div>
        </div>
        
        <div class="account-summary">
          <div class="account-summary-header">RESUMEN DE CUENTA</div>
          <div class="account-summary-row">
            <div class="account-summary-label">FECHA</div>
            <div class="account-summary-value">{{ today|date:'j/n/y' }}</div>
          </div>
          <div class="account-summary-row">
            <div class="account-summary-label">SALDO</div>
            <div class="account-summary-value {% if net_balance < 0 %}text-danger{% else %}text-success{% endif %}">
              {% if net_balance < 0 %}-${{ net_balance|floatformat:2|slice:'1:' }}{% else %}${{ net_balance|floatformat:2 }}{% endif %}
            </div>
          </div>
        </div>
      </div>
      <!-- Tabla de transacciones -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h5>Detalle de Movimientos</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped" id="movementsTable">
                  <thead>
                    <tr>
                      <th>FECHA</th>
                      <th>DOCUMENTO</th>
                      <th>TIEMPO DE CREDITO</th>
                      <th>VALOR</th>
                      <th>PAGO RECIBIDO</th>
                      <th>SALDO ACTUAL</th>
                      <th>REFERENCIA</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for e in entries %}
                      {% if e.type == 'INVOICE' %}
                      <tr class="{% if e.reference == 'FACTURA VENCIDA' %}invoice-overdue{% endif %}">
                        <td>{{ e.date|date:'j \d\e F \d\e Y' }}</td>
                        <td>{{ e.document }}</td>
                        <td class="text-center">{{ e.credit_days }}</td>
                        <td class="text-end">${{ e.invoice_amount|floatformat:2 }}</td>
                        <td class="text-end">{% if e.payment_amount %}${{ e.payment_amount|floatformat:2 }}{% endif %}</td>
                        <td class="text-end">${{ e.balance|floatformat:2 }}</td>
                        <td class="text-center">
                          {% if e.reference == 'FACTURA VENCIDA' %}<span class="text-danger">FACTURA VENCIDA</span>
                          {% else %}{{ e.reference }}{% endif %}
                        </td>
                      </tr>
                      {% else %}
                      <tr class="payment-row">
                        <td>{{ e.date|date:'j \d\e F \d\e Y' }}</td>
                        <td>{{ e.document }}</td>
                        <td></td>
                        <td></td>
                        <td class="text-end">${{ e.payment_amount|floatformat:2 }}</td>
                        <td></td>
                        <td class="text-center">PAGO RECIBIDO</td>
                      </tr>
                      {% endif %}
                    {% empty %}
                    <tr>
                      <td colspan="7" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <br>
                        Sin movimientos en el período seleccionado
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="3" class="text-end">TOTAL PENDIENTE</td>
                      <td class="text-end">${{ total_invoices_amount|floatformat:2 }}</td>
                      <td class="text-end">${{ total_payments_amount|floatformat:2 }}</td>
                      <td class="text-end">${{ total_pending_balance|floatformat:2 }}</td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      </div>
{% endblock %}

{% block files_footer %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}

{% block script %}

    <script>
      // Inicializar DataTable para la tabla de movimientos
      $(document).ready(function() {
        $('#movementsTable').DataTable({
          lengthMenu: [15, 25, 50, 100, 500],
          order: [[0, 'desc']]  // Ordenar por fecha descendente por defecto
        });
      });

      (function(){
        const input = document.getElementById('partnerSearch');
        const hiddenId = document.getElementById('partnerIdInput');
        const box = document.getElementById('partnerSuggestions');
        let controller = null;
        
        function clearBox(){ 
          box.innerHTML=''; 
          box.style.display='none'; 
        }
        
        function render(list){
          if(!list.length){ 
            clearBox(); 
            return; 
          }
          box.innerHTML='';
          list.forEach(item=>{
            const div = document.createElement('div');
            div.className = 'partner-suggestion';
            div.textContent = `${item.name} (${item.tax_id})`;
            div.addEventListener('click', e => {
              e.preventDefault(); 
              hiddenId.value = item.id; 
              input.value = item.name; 
              clearBox();
            });
            box.appendChild(div);
          });
          box.style.display='block';
        }
        
        let lastQuery='';
        input.addEventListener('input', function(){
          const q = this.value.trim();
          if(q.length < 2){ 
            clearBox(); 
            return; 
          }
          if(q === lastQuery) return; 
          lastQuery = q;
          if(controller) controller.abort();
          controller = new AbortController();
          fetch(`/reports/partner-search/?q=${encodeURIComponent(q)}`, {signal: controller.signal})
            .then(r => r.json())
            .then(data => { 
              render(data.results || []); 
            })
            .catch(() => {});
        });
        
        document.addEventListener('click', e => { 
          if(!box.contains(e.target) && e.target !== input){ 
            clearBox(); 
          } 
        });
        
        // Si ya viene un partner seleccionado, asegurar valor visible
        if(hiddenId.value && !input.value){
          // opcional: se podría hacer fetch para traer el nombre
        }
      })();
    </script>
{% endblock %}
