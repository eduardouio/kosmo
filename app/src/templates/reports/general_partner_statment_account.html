{% extends 'base/base.html' %}
{% load static %}

{% block files_header %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
{% endblock files_header %}

{% block style %}
<style>
  /* Estilos específicos para el estado de cuenta general - estilo simple */
  .filters-section {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #e5e7eb;
  }
  .filters-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr auto;
    gap: 15px;
    align-items: end;
  }
  .form-group {
    display: flex;
    flex-direction: column;
  }
  .form-label {
    font-weight: bold;
    color: #6b7280;
    margin-bottom: 5px;
    font-size: 0.9em;
  }
  .form-control {
    padding: 8px 12px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
  }
  .btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    font-size: 14px;
  }
  .btn-primary {
    background-color: #495057;
    color: white;
  }
  .btn-primary:hover {
    background-color: #343a40;
  }
  .section-title {
    color: #495057;
    font-size: 1.1em;
    margin: 15px 0 10px 0;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 5px;
    font-weight: 600;
  }
  .consolidated-table {
    background: white;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  .summary-card {
    background-color: #f8f9fa;
    color: #495057;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #e5e7eb;
  }
  .summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
  }
  .stat-item {
    text-align: center;
    padding: 15px;
    background-color: white;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
  }
  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 5px;
  }
  .stat-label {
    font-size: 0.9rem;
    color: #6b7280;
  }
  .table-responsive {
    border-radius: 8px;
    border: 1px solid #e5e7eb;
  }
  .table th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
  }
  .text-end {
    text-align: right;
  }
  .text-center {
    text-align: center;
  }
  .text-danger {
    color: #dc3545;
  }
  .text-success {
    color: #28a745;
  }
  .text-muted {
    color: #6b7280;
  }
  .account-summary-header {
    font-weight: bold;
    font-size: 1.2em;
    margin-bottom: 10px;
    color: #495057;
  }
  .account-summary-row {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid #e5e7eb;
  }
  .account-summary-label {
    font-weight: 600;
  }
  .account-summary-value {
    font-weight: bold;
  }
  .invoice-overdue {
    background-color: #ffe6e6;
  }
  .payment-row {
    background-color: #e6f7ff;
  }
  .partner-suggestion {
    padding: 8px;
    cursor: pointer;
    border-bottom: 1px solid #e5e7eb;
  }
  .partner-suggestion:hover {
    background-color: #f8f9fa;
  }
</style>
{% endblock style %}

{% block content %}
<div class="container">
  <!-- Filtros -->
  <div class="filters-section">
    <h2 class="section-title">Estado de Cuenta General</h2>
    <form method="get">
      <div class="filters-grid">
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select name="partner_type" class="form-control">
            <option value="CLIENTE" {% if partner_type == 'CLIENTE' %}selected{% endif %}>CLIENTES</option>
            <option value="PROVEEDOR" {% if partner_type == 'PROVEEDOR' %}selected{% endif %}>PROVEEDORES</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Desde</label>
          <input type="date" name="start_date" class="form-control" value="{{ start_date|date:'Y-m-d' }}">
        </div>
        <div class="form-group">
          <label class="form-label">Hasta</label>
          <input type="date" name="end_date" class="form-control" value="{{ end_date|date:'Y-m-d' }}">
        </div>
        <button class="btn btn-primary">Filtrar</button>
      </div>
    </form>
  </div>

  {% if not partner_id %}
  <!-- Vista Consolidada -->
  <div class="summary-card">
    <h3 class="mb-3">Resumen {{ partner_type }}S - {{ start_date|date:'d/m/Y' }} al {{ end_date|date:'d/m/Y' }}</h3>
    <div class="summary-stats">
      <div class="stat-item">
        <div class="stat-value">{{ partners_count }}</div>
        <div class="stat-label">{{ partner_type }}S</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${{ total_global_invoices|floatformat:2 }}</div>
        <div class="stat-label">Total Facturado</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">${{ total_global_payments|floatformat:2 }}</div>
        <div class="stat-label">Total Pagado</div>
      </div>
      <div class="stat-item">
        <div class="stat-value {% if total_global_balance < 0 %}text-danger{% endif %}">${{ total_global_balance|floatformat:2 }}</div>
        <div class="stat-label">Saldo Pendiente</div>
      </div>
    </div>
  </div>

  <!-- Tabla Consolidada -->
  <div class="card consolidated-table">
    <div class="card-header bg-light">
      <h5 class="mb-1">Detalle por {{ partner_type }}</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover" id="consolidatedTable">
          <thead>
            <tr>
              <th>{{ partner_type }}</th>
              <th>Ciudad/País</th>
              <th>Facturas</th>
              <th>Vencidas</th>
              <th class="text-end">Total Facturado</th>
              <th class="text-end">Total Pagado</th>
              <th class="text-end">Saldo Pendiente</th>
              <th>Crédito</th>
            </tr>
          </thead>
          <tbody>
            {% for item in partners_summary %}
              <tr>
              <td>
                <strong>{{ item.partner.name }}</strong>
                <br><small class="text-muted">{{ item.partner.business_tax_id }}</small>
              </td>
              <td>{{ item.partner.city|upper }}/{{ item.partner.country|upper }}</td>
              <td class="text-center">
                <span class="badge bg-secondary">{{ item.invoice_count }}</span>
              </td>
              <td class="text-center">
                {% if item.overdue_count > 0 %}
                  <span class="badge bg-danger">{{ item.overdue_count }}</span>
                {% else %}
                  <span class="badge bg-success">0</span>
                {% endif %}
              </td>
              <td class="text-end">${{ item.total_invoices|floatformat:2 }}</td>
              <td class="text-end">${{ item.total_payments|floatformat:2 }}</td>
              <td class="text-end {% if item.total_balance > 0 %}text-danger{% else %}text-success{% endif %}">
                ${{ item.total_balance|floatformat:2 }}
              </td>
              <td class="text-center">{{ item.partner.credit_term }} días</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                <i class="las la-inbox la-2x mb-2"></i><br>
                No hay {{ partner_type|lower }}s con movimientos en el período
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <!-- Vista Individual -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">{{ partner.name }} - {{ partner.business_tax_id }}</h5>
          <a href="?partner_type={{ partner_type }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}" class="btn btn-sm btn-outline-secondary">← Volver al Consolidado</a>
        </div>
        <div class="card-body">
          <div class="account-summary">
            <div class="account-summary-header">RESUMEN DE CUENTA</div>
            <div class="account-summary-row">
              <div class="account-summary-label">FECHA</div>
              <div class="account-summary-value">{{ today|date:'d/m/Y' }}</div>
            </div>
            <div class="account-summary-row">
              <div class="account-summary-label">PERÍODO</div>
              <div class="account-summary-value">{{ start_date|date:'d/m/Y' }} - {{ end_date|date:'d/m/Y' }}</div>
            </div>
            <div class="account-summary-row">
              <div class="account-summary-label">SALDO NETO</div>
              <div class="account-summary-value {% if net_balance < 0 %}text-danger{% else %}text-success{% endif %}">
                {% if net_balance < 0 %}-${{ net_balance|floatformat:2|slice:'1:' }}{% else %}${{ net_balance|floatformat:2 }}{% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla individual -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Detalle de Movimientos - {{ partner.type_partner }}</h5>
          <a href="?partner_type={{ partner_type }}&start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}" class="btn btn-sm btn-outline-secondary">← Volver al Consolidado</a>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped" id="movementsTable">
              <thead>
                <tr>
                  <th>FECHA</th>
                  <th>DOCUMENTO</th>
                  <th>TIPO</th>
                  <th>TIEMPO CRÉDITO</th>
                  <th>VALOR</th>
                  <th>PAGO</th>
                  <th>SALDO</th>
                  <th>REFERENCIA</th>
                </tr>
              </thead>
              <tbody>
                {% for e in entries %}
                  {% if e.type == 'INVOICE' %}
                  <tr class="{% if e.reference == 'FACTURA VENCIDA' %}invoice-overdue{% endif %}">
                    <td>{{ e.date|date:'d/m/Y' }}</td>
                    <td>{{ e.document }}</td>
                    <td>
                      {% if e.document_type == 'FAC_VENTA' %}
                        <span class="badge bg-secondary">VENTA</span>
                      {% else %}
                        <span class="badge bg-dark">COMPRA</span>
                      {% endif %}
                    </td>
                    <td class="text-center">{{ e.credit_days }}</td>
                    <td class="text-end">${{ e.invoice_amount|floatformat:2 }}</td>
                    <td class="text-end">{% if e.payment_amount %}${{ e.payment_amount|floatformat:2 }}{% endif %}</td>
                    <td class="text-end">${{ e.balance|floatformat:2 }}</td>
                    <td class="text-center">
                      {% if e.reference == 'FACTURA VENCIDA' %}
                        <span class="text-danger">FACTURA VENCIDA</span>
                      {% else %}
                        {{ e.reference }}
                      {% endif %}
                    </td>
                  </tr>
                  {% else %}
                  <tr class="payment-row">
                    <td>{{ e.date|date:'d/m/Y' }}</td>
                    <td>{{ e.document }}</td>
                    <td><span class="badge bg-light text-dark">PAGO</span></td>
                    <td></td>
                    <td></td>
                    <td class="text-end">${{ e.payment_amount|floatformat:2 }}</td>
                    <td></td>
                    <td class="text-center">{{ e.reference }}</td>
                  </tr>
                  {% endif %}
                {% empty %}
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    <i class="las la-inbox la-2x mb-2"></i>
                    <br>
                    Sin movimientos en el período seleccionado
                  </td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="table-light">
                  <td colspan="4" class="text-end"><strong>TOTALES</strong></td>
                  <td class="text-end"><strong>${{ total_invoices_amount|floatformat:2 }}</strong></td>
                  <td class="text-end"><strong>${{ total_payments_amount|floatformat:2 }}</strong></td>
                  <td class="text-end"><strong>${{ total_pending_balance|floatformat:2 }}</strong></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock content %}

{% block files_footer %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
{% endblock files_footer %}

{% block script %}
<script>
  // Inicializar DataTables
  $(document).ready(function() {
    $('#consolidatedTable').DataTable({
      lengthMenu: [15, 25, 50, 100],
      order: [[0, 'asc']],
      language: {
        lengthMenu: "_MENU_ registros por página",
        zeroRecords: "Sin registros",
        info: "Mostrando página _PAGE_ de _PAGES_",
        infoEmpty: "Sin registros",
        infoFiltered: "(filtrado de _MAX_ registros totales)",
        search: "Buscar:",
        paginate: {
          first: "Primero",
          last: "Último",
          next: "Siguiente",
          previous: "Anterior"
        }
      }
    });

    $('#movementsTable').DataTable({
      lengthMenu: [15, 25, 50, 100, 500],
      order: [[0, 'desc']],
      language: {
        lengthMenu: "_MENU_ registros por página",
        zeroRecords: "Sin registros",
        info: "Mostrando página _PAGE_ de _PAGES_",
        infoEmpty: "Sin registros",
        infoFiltered: "(filtrado de _MAX_ registros totales)",
        search: "Buscar:",
        paginate: {
          first: "Primero",
          last: "Último",
          next: "Siguiente",
          previous: "Anterior"
        }
      }
    });
  });
  </script>
{% endblock script %}
