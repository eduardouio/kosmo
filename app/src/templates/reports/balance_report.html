{% extends 'base/base.html' %}
{% load static %}

{% block style %}
<style>
    .filter-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .balance-card {
        border-radius: 10px;
        padding: 18px;
        margin-bottom: 15px;
        color: white;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .balance-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        pointer-events: none;
    }
    .balance-card.compras {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    .balance-card.ventas {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    .balance-card.utilidad {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    .balance-card.flujo {
        background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
    }
    .balance-card h3 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: bold;
    }
    .balance-card .subtitle {
        opacity: 0.9;
        font-size: 0.9rem;
        margin-top: 3px;
    }
    .kpi-card {
        background: white;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 10px;
    }
    .kpi-card h5 {
        color: #495057;
        margin: 0;
        font-size: 1.4rem;
    }
    .kpi-card small {
        color: #6c757d;
        display: block;
        margin-top: 3px;
        font-size: 0.8rem;
    }
    .balance-scale {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0;
        position: relative;
    }
    .scale-left, .scale-right {
        width: 120px;
        height: 80px;
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-align: center;
        position: relative;
        font-size: 0.8rem;
    }
    .scale-left {
        background: linear-gradient(135deg, #dc3545, #c82333);
        margin-right: 15px;
    }
    .scale-right {
        background: linear-gradient(135deg, #28a745, #20c997);
        margin-left: 15px;
    }
    .scale-center {
        width: 40px;
        height: 40px;
        background: #6c757d;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        position: relative;
        z-index: 2;
        font-size: 1.2rem;
    }
    .scale-beam {
        position: absolute;
        width: 280px;
        height: 3px;
        background: #6c757d;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
    }
    .trend-positive {
        color: #28a745;
    }
    .trend-negative {
        color: #dc3545;
    }
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    .compact-table {
        background: white;
        border-radius: 8px;
        padding: 1px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    .compact-table h6 {
        margin: 0;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .compact-table table {
        margin: 0;
        font-size: 0.8rem;
    }
    .compact-table .table td,
    .compact-table .table th {
        padding: 4px 8px !important;
        border: none;
        vertical-align: middle;
    }
    .compact-table .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    .compact-table .badge {
        font-size: 0.7rem;
        padding: 2px 6px;
    }
    .balance-summary {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block files_header %}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-3">
                <i class="fas fa-balance-scale me-2"></i>
                Balance Financiero
            </h3>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row">
        <div class="col-12">
            <div class="filter-card">
                <form method="GET" id="filterForm">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label for="date_from" class="form-label small">Fecha Desde</label>
                            <input type="date" class="form-control form-control-sm" id="date_from" name="date_from" 
                                   value="{{ filters.date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label small">Fecha Hasta</label>
                            <input type="date" class="form-control form-control-sm" id="date_to" name="date_to" 
                                   value="{{ filters.date_to }}">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="d-flex gap-1">
                                <button type="submit" class="btn btn-default btn-sm">
                                    <i class="fas fa-search me-1"></i>Analizar
                                </button>
                                <button type="button" class="btn btn-default btn-sm" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Limpiar
                                </button>
                                <button type="button" class="btn btn-default btn-sm" onclick="exportReport()">
                                    <i class="fas fa-download me-1"></i>Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Balance Principal -->
    <div class="row">
        <div class="col-md-2 col-6">
            <div class="balance-card compras">
                <h3>${{ total_compras|floatformat:0 }}</h3>
                <div class="subtitle">Compras</div>
                <small>{{ count_compras }} órdenes</small>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="balance-card ventas">
                <h3>${{ total_ventas|floatformat:0 }}</h3>
                <div class="subtitle">Ventas</div>
                <small>{{ count_ventas }} órdenes</small>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="balance-card" style="background: linear-gradient(135deg, #fd7e14 0%, #e8590c 100%);">
                <h3>${{ total_margen|floatformat:0 }}</h3>
                <div class="subtitle">Margen</div>
                <small>{{ margen_contribucion|floatformat:1 }}% del total</small>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="balance-card utilidad">
                <h3 class="{% if utilidad_bruta >= 0 %}text-white{% else %}text-white{% endif %}">
                    ${{ utilidad_bruta|floatformat:0 }}
                </h3>
                <div class="subtitle">Utilidad</div>
                <small>{{ rentabilidad|floatformat:1 }}% rent.</small>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="balance-card flujo">
                <h3>${{ flujo_efectivo|floatformat:0 }}</h3>
                <div class="subtitle">Flujo</div>
                <small>Efectivo</small>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="balance-card" style="background: linear-gradient(135deg, #20c997 0%, #198754 100%);">
                <h3>{{ kpis.roi|floatformat:1 }}%</h3>
                <div class="subtitle">ROI Real</div>
                <small>Margen/Inversión</small>
            </div>
        </div>
    </div>

    <!-- Balanza Compacta -->
    <div class="row">
        <div class="col-md-8">
            <div class="balance-summary">
                <h6 class="text-center mb-3">Balanza Compras vs Ventas</h6>
                <div class="balance-scale">
                    <div class="scale-left">
                        <div>
                            <div>COMPRAS</div>
                            <div>${{ total_compras|floatformat:0 }}</div>
                        </div>
                    </div>
                    <div class="scale-center">
                        {% if utilidad_bruta >= 0 %}
                            <i class="fas fa-arrow-up"></i>
                        {% else %}
                            <i class="fas fa-arrow-down"></i>
                        {% endif %}
                    </div>
                    <div class="scale-right">
                        <div>
                            <div>VENTAS</div>
                            <div>${{ total_ventas|floatformat:0 }}</div>
                        </div>
                    </div>
                    <div class="scale-beam"></div>
                </div>
                <div class="text-center">
                    <h6 class="{% if utilidad_bruta >= 0 %}trend-positive{% else %}trend-negative{% endif %}">
                        {% if utilidad_bruta >= 0 %}
                            Utilidad: ${{ utilidad_bruta|floatformat:0 }}
                        {% else %}
                            Pérdida: ${{ utilidad_bruta|floatformat:0 }}
                        {% endif %}
                    </h6>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container" style="height: 250px;">
                <h6>Flujo de Efectivo</h6>
                <canvas id="cashFlowChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <!-- KPIs Compactos -->
    <div class="row">
        <div class="col-md-3 col-6">
            <div class="kpi-card">
                <h5>${{ total_margen|floatformat:0 }}</h5>
                <small>Margen Total</small>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="kpi-card">
                <h5>{{ margen_contribucion|floatformat:1 }}%</h5>
                <small>% Margen</small>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="kpi-card">
                <h5>${{ kpis.ticket_promedio_venta|floatformat:0 }}</h5>
                <small>Ticket Venta</small>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="kpi-card">
                <h5>{{ kpis.ratio_ventas_compras|floatformat:1 }}</h5>
                <small>Ratio V/C</small>
            </div>
        </div>
    </div>

    <!-- Gráfico Temporal -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container" style="height: 250px;">
                <h6>Evolución Últimos 6 Meses</h6>
                <canvas id="timeChart" height="180"></canvas>
            </div>
        </div>
    </div>

    <!-- Tablas Compactas -->
    <div class="row">
        <div class="col-md-6">
            <div class="compact-table">
                <h6>Top Proveedores</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th style="width: 60%;">Proveedor</th>
                            <th style="width: 20%;" class="text-center">Órd.</th>
                            <th style="width: 20%;" class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proveedor in compras_por_proveedor|slice:":8" %}
                        <tr>
                            <td>
                                <strong class="text-truncate d-block" style="max-width: 150px;">
                                    {{ proveedor.partner__name|truncatechars:25 }}
                                </strong>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-secondary">{{ proveedor.count }}</span>
                            </td>
                            <td class="text-end">
                                <span class="badge bg-danger">${{ proveedor.total|floatformat:0 }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted">Sin datos</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="col-md-6">
            <div class="compact-table">
                <h6>Top Clientes</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th style="width: 50%;">Cliente</th>
                            <th style="width: 15%;" class="text-center">Órd.</th>
                            <th style="width: 17%;" class="text-end">Margen</th>
                            <th style="width: 18%;" class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cliente in ventas_por_cliente|slice:":8" %}
                        <tr>
                            <td>
                                <strong class="text-truncate d-block" style="max-width: 120px;">
                                    {{ cliente.partner__name|truncatechars:20 }}
                                </strong>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-secondary">{{ cliente.count }}</span>
                            </td>
                            <td class="text-end">
                                <small class="text-muted">${{ cliente.margin|floatformat:0 }}</small>
                            </td>
                            <td class="text-end">
                                <span class="badge bg-success">${{ cliente.total|floatformat:0 }}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted">Sin datos</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block files_footer %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block script %}
<script>
    // Gráfico de evolución temporal
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    const monthlyData = JSON.parse('{{ monthly_data_json|escapejs }}');

    new Chart(timeCtx, {
        type: 'line',
        data: {
            labels: monthlyData.map(item => item.month),
            datasets: [
                {
                    label: 'Compras',
                    data: monthlyData.map(item => item.purchases),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'Ventas',
                    data: monthlyData.map(item => item.sales),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'Utilidad',
                    data: monthlyData.map(item => item.profit),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 11
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: {
                            size: 10
                        },
                        maxTicksLimit: 5,
                        callback: function(value) {
                            return '$' + (value/1000).toFixed(0) + 'K';
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 10
                        }
                    }
                }
            },
            layout: {
                padding: {
                    top: 10,
                    bottom: 10
                }
            }
        }
    });

    // Gráfico de flujo de efectivo
    const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
    new Chart(cashFlowCtx, {
        type: 'doughnut',
        data: {
            labels: ['Ingresos', 'Egresos'],
            datasets: [{
                data: [{{ ingresos }}, {{ egresos }}],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 10
                        },
                        boxWidth: 12,
                        padding: 10
                    }
                }
            },
            layout: {
                padding: {
                    top: 10,
                    bottom: 5
                }
            }
        }
    });

    // Funciones auxiliares
    function clearFilters() {
        document.getElementById('filterForm').reset();
        document.getElementById('filterForm').submit();
    }

    function exportReport() {
        alert('Función de exportación por implementar');
    }
</script>
{% endblock %}
