{% extends 'base/base.html' %}
{% load static %}

{% block style %}
<style>
    .filter-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .balance-card {
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        color: white;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .balance-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        pointer-events: none;
    }
    .balance-card.compras {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    .balance-card.ventas {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    .balance-card.utilidad {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    .balance-card.flujo {
        background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
    }
    .balance-card h2 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: bold;
    }
    .balance-card .subtitle {
        opacity: 0.9;
        font-size: 1.1rem;
        margin-top: 5px;
    }
    .kpi-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    .kpi-card h4 {
        color: #495057;
        margin: 0;
        font-size: 1.8rem;
    }
    .kpi-card small {
        color: #6c757d;
        display: block;
        margin-top: 5px;
    }
    .balance-scale {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 30px 0;
        position: relative;
    }
    .scale-left, .scale-right {
        width: 200px;
        height: 150px;
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-align: center;
        position: relative;
    }
    .scale-left {
        background: linear-gradient(135deg, #dc3545, #c82333);
        margin-right: 20px;
    }
    .scale-right {
        background: linear-gradient(135deg, #28a745, #20c997);
        margin-left: 20px;
    }
    .scale-center {
        width: 60px;
        height: 60px;
        background: #6c757d;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        position: relative;
        z-index: 2;
    }
    .scale-beam {
        position: absolute;
        width: 400px;
        height: 4px;
        background: #6c757d;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
    }
    .trend-positive {
        color: #28a745;
    }
    .trend-negative {
        color: #dc3545;
    }
    .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .top-list {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .list-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e9ecef;
    }
    .list-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block files_header %}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-balance-scale me-2"></i>
                Balance Financiero
            </h2>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row">
        <div class="col-12">
            <div class="filter-card">
                <form method="GET" id="filterForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="date_from" class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" id="date_from" name="date_from" 
                                   value="{{ filters.date_from }}">
                        </div>
                        <div class="col-md-4">
                            <label for="date_to" class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" id="date_to" name="date_to" 
                                   value="{{ filters.date_to }}">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Analizar
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Limpiar
                                </button>
                                <button type="button" class="btn btn-success" onclick="exportReport()">
                                    <i class="fas fa-download me-1"></i>Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Balance Principal -->
    <div class="row">
        <div class="col-md-3">
            <div class="balance-card compras">
                <h2>${{ total_compras|floatformat:2 }}</h2>
                <div class="subtitle">Total Compras</div>
                <small>{{ count_compras }} órdenes</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="balance-card ventas">
                <h2>${{ total_ventas|floatformat:2 }}</h2>
                <div class="subtitle">Total Ventas</div>
                <small>{{ count_ventas }} órdenes</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="balance-card utilidad">
                <h2 class="{% if utilidad_bruta >= 0 %}trend-positive{% else %}trend-negative{% endif %}">
                    ${{ utilidad_bruta|floatformat:2 }}
                </h2>
                <div class="subtitle">Utilidad Bruta</div>
                <small>{{ rentabilidad|floatformat:1 }}% rentabilidad</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="balance-card flujo">
                <h2 class="{% if flujo_efectivo >= 0 %}trend-positive{% else %}trend-negative{% endif %}">
                    ${{ flujo_efectivo|floatformat:2 }}
                </h2>
                <div class="subtitle">Flujo de Efectivo</div>
                <small>Ingresos - Egresos</small>
            </div>
        </div>
    </div>

    <!-- Balanza Visual -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <h5 class="text-center mb-4">Balanza Compras vs Ventas</h5>
                <div class="balance-scale">
                    <div class="scale-left">
                        <div>
                            <div>COMPRAS</div>
                            <div>${{ total_compras|floatformat:0 }}</div>
                        </div>
                    </div>
                    <div class="scale-center">
                        {% if utilidad_bruta >= 0 %}
                            <i class="fas fa-arrow-up trend-positive"></i>
                        {% else %}
                            <i class="fas fa-arrow-down trend-negative"></i>
                        {% endif %}
                    </div>
                    <div class="scale-right">
                        <div>
                            <div>VENTAS</div>
                            <div>${{ total_ventas|floatformat:0 }}</div>
                        </div>
                    </div>
                    <div class="scale-beam"></div>
                </div>
                <div class="text-center">
                    <h4 class="{% if utilidad_bruta >= 0 %}trend-positive{% else %}trend-negative{% endif %}">
                        {% if utilidad_bruta >= 0 %}
                            Utilidad de ${{ utilidad_bruta|floatformat:2 }}
                        {% else %}
                            Pérdida de ${{ utilidad_bruta|floatformat:2 }}
                        {% endif %}
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row">
        <div class="col-md-3">
            <div class="kpi-card">
                <h4>{{ kpis.roi|floatformat:1 }}%</h4>
                <small>ROI (Retorno de Inversión)</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card">
                <h4>{{ margen_contribucion|floatformat:1 }}%</h4>
                <small>Margen de Contribución</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card">
                <h4>${{ kpis.ticket_promedio_venta|floatformat:2 }}</h4>
                <small>Ticket Promedio Venta</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card">
                <h4>{{ kpis.ratio_ventas_compras|floatformat:2 }}</h4>
                <small>Ratio Ventas/Compras</small>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row">
        <div class="col-md-8">
            <div class="chart-container">
                <h5>Evolución Temporal - Últimos 6 Meses</h5>
                <canvas id="timeChart" width="400" height="200"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="top-list">
                <h5>Distribución de Ingresos vs Egresos</h5>
                <canvas id="cashFlowChart" width="300" height="300"></canvas>
                <div class="mt-3">
                    <div class="d-flex justify-content-between">
                        <span>Ingresos:</span>
                        <span class="trend-positive">${{ ingresos|floatformat:2 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Egresos:</span>
                        <span class="trend-negative">${{ egresos|floatformat:2 }}</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Balance:</strong>
                        <strong class="{% if flujo_efectivo >= 0 %}trend-positive{% else %}trend-negative{% endif %}">
                            ${{ flujo_efectivo|floatformat:2 }}
                        </strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Proveedores y Clientes -->
    <div class="row">
        <div class="col-md-6">
            <div class="top-list">
                <h5>Top Proveedores (Compras)</h5>
                {% for proveedor in compras_por_proveedor %}
                <div class="list-item">
                    <div>
                        <strong>{{ proveedor.partner__name|truncatechars:30 }}</strong>
                        <small class="d-block text-muted">{{ proveedor.count }} órdenes</small>
                    </div>
                    <span class="badge bg-danger">${{ proveedor.total|floatformat:2 }}</span>
                </div>
                {% empty %}
                <p class="text-muted">No hay datos de compras disponibles</p>
                {% endfor %}
            </div>
        </div>
        <div class="col-md-6">
            <div class="top-list">
                <h5>Top Clientes (Ventas)</h5>
                {% for cliente in ventas_por_cliente %}
                <div class="list-item">
                    <div>
                        <strong>{{ cliente.partner__name|truncatechars:30 }}</strong>
                        <small class="d-block text-muted">
                            {{ cliente.count }} órdenes | Margen: ${{ cliente.margin|floatformat:2 }}
                        </small>
                    </div>
                    <span class="badge bg-success">${{ cliente.total|floatformat:2 }}</span>
                </div>
                {% empty %}
                <p class="text-muted">No hay datos de ventas disponibles</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block files_footer %}
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block script %}
<script>
    // Gráfico de evolución temporal
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    const monthlyData = JSON.parse('{{ monthly_data_json|escapejs }}');

    new Chart(timeCtx, {
        type: 'line',
        data: {
            labels: monthlyData.map(item => item.month),
            datasets: [
                {
                    label: 'Compras',
                    data: monthlyData.map(item => item.purchases),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Ventas',
                    data: monthlyData.map(item => item.sales),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'Utilidad',
                    data: monthlyData.map(item => item.profit),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Gráfico de flujo de efectivo
    const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
    new Chart(cashFlowCtx, {
        type: 'doughnut',
        data: {
            labels: ['Ingresos', 'Egresos'],
            datasets: [{
                data: [{{ ingresos }}, {{ egresos }}],
                backgroundColor: ['#28a745', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Funciones auxiliares
    function clearFilters() {
        document.getElementById('filterForm').reset();
        document.getElementById('filterForm').submit();
    }

    function exportReport() {
        alert('Función de exportación por implementar');
    }
</script>
{% endblock %}
