{% extends 'base/base.html' %}
{% load static %}
{% load l10n %}

{% block style %}
<style>
    .filter-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .balance-card {
        border-radius: 10px;
        padding: 18px;
        margin-bottom: 15px;
        color: white;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .balance-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        pointer-events: none;
    }
    .balance-card.compras {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    }
    .balance-card.ventas {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    .balance-card.utilidad {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }
    .balance-card.flujo {
        background: linear-gradient(135deg, #6f42c1 0%, #5a2d91 100%);
    }
    .balance-card h3 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: bold;
    }
    .balance-card h4 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: bold;
    }
    .balance-card .subtitle {
        opacity: 0.9;
        font-size: 0.9rem;
        margin-top: 3px;
    }
    .balance-card.compact {
        padding: 12px;
        margin-bottom: 10px;
        min-height: 85px;
    }
    .balance-card.compact .subtitle {
        font-size: 0.8rem;
        margin-top: 2px;
    }
    .balance-card.compact small {
        font-size: 0.7rem;
    }
    .balance-scale {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px 0;
        position: relative;
    }
    .scale-left, .scale-right {
        width: 120px;
        height: 80px;
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        text-align: center;
        position: relative;
        font-size: 0.8rem;
        transition: transform 0.5s ease;
    }
    .scale-left {
        background: linear-gradient(135deg, #dc3545, #c82333);
        margin-right: 15px;
    }
    .scale-right {
        background: linear-gradient(135deg, #28a745, #20c997);
        margin-left: 15px;
    }
    .scale-center {
        width: 40px;
        height: 40px;
        background: #6c757d;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        position: relative;
        z-index: 2;
        font-size: 1.2rem;
    }
    .scale-beam {
        position: absolute;
        width: 280px;
        height: 3px;
        background: #6c757d;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1;
        transition: transform 0.5s ease;
        transform-origin: center;
    }
    .trend-positive {
        color: #28a745;
    }
    .trend-negative {
        color: #dc3545;
    }
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    .compact-table {
        background: white;
        border-radius: 8px;
        padding: 1px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    .compact-table h6 {
        margin: 0;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .compact-table table {
        margin: 0;
        font-size: 0.8rem;
    }
    .compact-table .table td,
    .compact-table .table th {
        padding: 4px 8px !important;
        border: none;
        vertical-align: middle;
    }
    .compact-table .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    .compact-table .badge {
        font-size: 0.7rem;
        padding: 2px 6px;
    }
    .balance-summary {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    
    /* Estilos para las cards y tablas (copiados de sales_report) */
    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }
    
    .summary-card {
        transition: transform 0.2s ease-in-out;
    }
    
    .summary-card:hover {
        transform: translateY(-2px);
    }
    
    /* Tablas scrolleables de tamaño fijo */
    .scrollable-table-card {
        height: 450px;
    }
    
    .scrollable-table-card .card-body {
        padding: 0;
        height: 400px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
        padding-bottom: 40px;
    }
    
    .scrollable-table-card .table-responsive {
        flex: 1;
        overflow-y: auto;
        font-size: 0.85rem;
    }
    
    .scrollable-table-card .table {
        margin: 0;
        width: 100%;
    }
    
    .scrollable-table-card .table th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
        border-top: none;
        font-size: 0.8rem;
        padding: 10px 8px;
        white-space: nowrap;
    }
    
    .scrollable-table-card .table td {
        font-size: 0.8rem;
        padding: 8px;
        white-space: nowrap;
        border-bottom: 1px solid #dee2e6;
    }
    
    .scrollable-table-card .table tr.expanded {
        background-color: #f8f9fa;
    }
    

    

    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .table-responsive {
            font-size: 0.875rem;
        }
        .scrollable-table-card {
            height: 300px;
        }
        .scrollable-table-card .card-body {
            height: 250px;
        }
        .balance-card.compact {
            padding: 8px;
            min-height: 70px;
        }
        .balance-card.compact h4 {
            font-size: 1.2rem;
        }
    }
    
    @media (max-width: 576px) {
        .balance-card.compact {
            margin-bottom: 8px;
        }
        .balance-card.compact h4 {
            font-size: 1.1rem;
        }
        .balance-card.compact .subtitle {
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block files_header %}
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-3">
                <i class="las la-balance-scale me-2"></i>
                Balance Financiero
            </h3>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row">
        <div class="col-12">
            <div class="filter-card">
                <form method="GET" id="filterForm">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label for="date_from" class="form-label small">Fecha Desde</label>
                            <input type="date" class="form-control form-control-sm" id="date_from" name="date_from" 
                                   value="{{ filters.date_from }}">
                        </div>
                        <div class="col-md-3">
                            <label for="date_to" class="form-label small">Fecha Hasta</label>
                            <input type="date" class="form-control form-control-sm" id="date_to" name="date_to" 
                                   value="{{ filters.date_to }}">
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="d-flex gap-1">
                                <button type="submit" class="btn btn-default btn-sm">
                                    <i class="las la-search me-1"></i>Analizar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Balance Principal -->
        <!-- Balance Principal -->
    <div class="row">
        <div class="col-lg col-md-3 col-6">
            <div class="balance-card compras compact">
                <h4>${{ total_compras|floatformat:0 }}</h4>
                <div class="subtitle">Compras</div>
                <small>{{ count_compras }} fact.</small>
            </div>
        </div>
        <div class="col-lg col-md-3 col-6">
            <div class="balance-card ventas compact">
                <h4>${{ total_ventas|floatformat:0 }}</h4>
                <div class="subtitle">Ventas</div>
                <small>{{ count_ventas }} fact.</small>
            </div>
        </div>
        <div class="col-lg col-md-3 col-6">
            <div class="balance-card compact" style="background: linear-gradient(135deg, #fd7e14 0%, #e8590c 100%);">
                <h4>${{ total_margen|floatformat:0 }}</h4>
                <div class="subtitle">Margen</div>
                <small>{{ margen_contribucion|floatformat:1 }}%</small>
            </div>
        </div>
        <div class="col-lg col-md-3 col-6">
            <div class="balance-card compact" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                <h4>${{ total_comisiones|floatformat:0 }}</h4>
                <div class="subtitle">Comisiones</div>
                <small>Gastos</small>
            </div>
        </div>
        <div class="col-lg col-md-3 col-6">
            <div class="balance-card utilidad compact">
                <h4 class="{% if utilidad_bruta >= 0 %}text-white{% else %}text-white{% endif %}">
                    ${{ utilidad_bruta|floatformat:0 }}
                </h4>
                <div class="subtitle">Utilidad</div>
                <small>{{ rentabilidad|floatformat:1 }}%</small>
            </div>
        </div>
        <div class="col-lg col-md-3 col-6">
            <div class="balance-card flujo compact">
                <h4>${{ flujo_efectivo|floatformat:0 }}</h4>
                <div class="subtitle">Flujo</div>
                <small>Efectivo</small>
            </div>
        </div>
        <div class="col-lg col-md-3 col-6">
            <div class="balance-card compact" style="background: linear-gradient(135deg, #20c997 0%, #198754 100%);">
                <h4>{{ kpis.roi|floatformat:1 }}%</h4>
                <div class="subtitle">ROI</div>
                <small>Retorno</small>
            </div>
        </div>
    </div>

    <!-- Balanza Compacta -->
    <div class="row">
        <div class="col-md-8">
            <div class="balance-summary">
                <h6 class="text-center mb-3">Balanza Compras vs Ventas</h6>
                <div class="balance-scale">
                    <div class="scale-left">
                        <div>
                            <div>COMPRAS</div>
                            <div>${{ total_compras|floatformat:0 }}</div>
                        </div>
                    </div>
                    <div class="scale-center">
                        {% if utilidad_bruta >= 0 %}
                            <i class="las la-arrow-up"></i>
                        {% else %}
                            <i class="las la-arrow-down"></i>
                        {% endif %}
                    </div>
                    <div class="scale-right">
                        <div>
                            <div>VENTAS</div>
                            <div>${{ total_ventas|floatformat:0 }}</div>
                        </div>
                    </div>
                    <div class="scale-beam"></div>
                </div>
                <div class="text-center">
                    <h6 class="{% if utilidad_bruta >= 0 %}trend-positive{% else %}trend-negative{% endif %}">
                        {% if utilidad_bruta >= 0 %}
                            Utilidad Neta: ${{ utilidad_bruta|floatformat:0 }}
                        {% else %}
                            Pérdida Neta: ${{ utilidad_bruta|floatformat:0 }}
                        {% endif %}
                    </h6>
                    <p class="mb-0 small text-muted">
                        Margen: ${{ total_margen|floatformat:0 }} - Comisiones: ${{ total_comisiones|floatformat:0 }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="chart-container" style="height: 250px;">
                <h6>Flujo de Efectivo</h6>
                <canvas id="cashFlowChart" height="150"></canvas>
            </div>
        </div>
    </div>

    <!-- Estado de Facturas -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6><i class="las la-file-invoice-dollar me-2"></i>Estado Facturas de Venta</h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                                <h5 class="text-success mb-1">{{ facturas_venta_pagadas }}</h5>
                                <small class="text-muted">Pagadas</small>
                                <div class="small text-success">${{ monto_ventas_pagadas|floatformat:0 }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-warning bg-opacity-10 rounded">
                                <h5 class="text-warning mb-1">{{ facturas_venta_pendientes }}</h5>
                                <small class="text-muted">Pendientes</small>
                                <div class="small text-warning">${{ monto_ventas_pendientes|floatformat:0 }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between small text-muted">
                            <span>Efectividad de Cobro</span>
                            <span class="fw-bold">{{ kpis.efectividad_cobro|floatformat:1 }}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6><i class="las la-receipt me-2"></i>Estado Facturas de Compra</h6>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                                <h5 class="text-success mb-1">{{ facturas_compra_pagadas }}</h5>
                                <small class="text-muted">Pagadas</small>
                                <div class="small text-success">${{ monto_compras_pagadas|floatformat:0 }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-2 bg-danger bg-opacity-10 rounded">
                                <h5 class="text-danger mb-1">{{ facturas_compra_pendientes }}</h5>
                                <small class="text-muted">Pendientes</small>
                                <div class="small text-danger">${{ monto_compras_pendientes|floatformat:0 }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between small text-muted">
                            <span>% Pagos al Día</span>
                            <span class="fw-bold">{{ kpis.porcentaje_facturas_compra_pagadas|floatformat:1 }}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico Temporal -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container" style="height: 250px;">
                <h6>Evolución Últimos 6 Meses</h6>
                <canvas id="timeChart" height="180"></canvas>
            </div>
        </div>
    </div>

    <!-- Tablas de Resumen -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card scrollable-table-card">
                <div class="card-header">
                    <h6><i class="las la-truck me-2"></i>Top Proveedores (Compras)</h6>
                </div>
                <div class="card-body">
                    {% if compras_por_proveedor %}
                        <div class="table-responsive">
                            <table id="tableProveedores" class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Proveedor</th>
                                        <th class="text-center">Qty</th>
                                        <th class="text-center">FB Equiv</th>
                                        <th class="text-center">Tallos</th>
                                        <th class="text-center">EB</th>
                                        <th class="text-center">HB</th>
                                        <th class="text-center">QB</th>
                                        <th class="text-center">FB</th>
                                        <th class="text-end">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for proveedor in compras_por_proveedor %}
                                    <tr>
                                        <td>{{ proveedor.partner__name }}</td>
                                        <td class="text-center">{{ proveedor.count }}</td>
                                        <td class="text-center">{{ proveedor.fb_equivalente|floatformat:1 }}</td>
                                        <td class="text-center">{{ proveedor.total_tallos|default:0 }}</td>
                                        <td class="text-center">{{ proveedor.total_eb|default:0 }}</td>
                                        <td class="text-center">{{ proveedor.total_hb|default:0 }}</td>
                                        <td class="text-center">{{ proveedor.total_qb|default:0 }}</td>
                                        <td class="text-center">{{ proveedor.total_fb|default:0 }}</td>
                                        <td class="text-end">${{ proveedor.total|floatformat:0 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <p class="text-muted mb-0">No hay datos disponibles</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabla de Clientes -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card scrollable-table-card">
                <div class="card-header">
                    <h6><i class="las la-users me-2"></i>Top Clientes (Ventas)</h6>
                </div>
                <div class="card-body">
                    {% if ventas_por_cliente %}
                        <div class="table-responsive">
                            <table id="tableClientes" class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th class="text-center">Qty</th>
                                        <th class="text-center">FB Equiv</th>
                                        <th class="text-center">Tallos</th>
                                        <th class="text-center">EB</th>
                                        <th class="text-center">HB</th>
                                        <th class="text-center">QB</th>
                                        <th class="text-center">FB</th>
                                        <th class="text-end">Margen</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cliente in ventas_por_cliente %}
                                    <tr>
                                        <td>{{ cliente.partner__name }}</td>
                                        <td class="text-center">{{ cliente.count }}</td>
                                        <td class="text-center">{{ cliente.fb_equivalente|floatformat:1 }}</td>
                                        <td class="text-center">{{ cliente.total_tallos|default:0 }}</td>
                                        <td class="text-center">{{ cliente.total_eb|default:0 }}</td>
                                        <td class="text-center">{{ cliente.total_hb|default:0 }}</td>
                                        <td class="text-center">{{ cliente.total_qb|default:0 }}</td>
                                        <td class="text-center">{{ cliente.total_fb|default:0 }}</td>
                                        <td class="text-end">${{ cliente.margin|floatformat:0 }}</td>
                                        <td class="text-end">${{ cliente.total|floatformat:0 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <p class="text-muted mb-0">No hay datos disponibles</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detalle de Flujo de Efectivo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card scrollable-table-card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="las la-arrow-down me-2"></i>Detalle de Cobros (Ingresos)</h6>
                </div>
                <div class="card-body">
                    {% if detalle_ingresos %}
                        <div class="table-responsive">
                            <table id="tableCobros" class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Fecha</th>
                                        <th>Método</th>
                                        <th class="text-end">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cobro in detalle_ingresos %}
                                    <tr>
                                        <td title="{{ cobro.payment_number|default:'N/A' }}">{{ cobro.payment_number|default:"N/A"|truncatechars:12 }}</td>
                                        <td>{{ cobro.date|date:"d/m/Y" }}</td>
                                        <td>{{ cobro.method }}</td>
                                        <td class="text-end">${{ cobro.amount|floatformat:0 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="position-absolute bottom-0 end-0 p-2 bg-white border-top w-100">
                            <div class="text-end">
                                <strong class="text-success">Total: ${{ ingresos|floatformat:0 }}</strong>
                            </div>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <p class="text-muted mb-0">Sin cobros registrados</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabla de Pagos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card scrollable-table-card">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0"><i class="las la-arrow-up me-2"></i>Detalle de Pagos (Egresos)</h6>
                </div>
                <div class="card-body">
                    {% if detalle_egresos %}
                        <div class="table-responsive">
                            <table id="tablePagos" class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Fecha</th>
                                        <th>Método</th>
                                        <th class="text-end">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for pago in detalle_egresos %}
                                    <tr>
                                        <td title="{{ pago.payment_number|default:'N/A' }}">{{ pago.payment_number|default:"N/A"|truncatechars:12 }}</td>
                                        <td>{{ pago.date|date:"d/m/Y" }}</td>
                                        <td>{{ pago.method }}</td>
                                        <td class="text-end">${{ pago.amount|floatformat:0 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="position-absolute bottom-0 end-0 p-2 bg-white border-top w-100">
                            <div class="text-end">
                                <strong class="text-danger">Total: ${{ egresos|floatformat:0 }}</strong>
                            </div>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <p class="text-muted mb-0">Sin pagos registrados</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block files_footer %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block script %}
<script>
    // Gráfico de evolución temporal
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    const monthlyData = JSON.parse('{{ monthly_data_json|escapejs }}');

    new Chart(timeCtx, {
        type: 'line',
        data: {
            labels: monthlyData.map(item => item.month),
            datasets: [
                {
                    label: 'Compras',
                    data: monthlyData.map(item => item.purchases),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'Ventas',
                    data: monthlyData.map(item => item.sales),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                },
                {
                    label: 'Utilidad',
                    data: monthlyData.map(item => item.profit),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        boxWidth: 12,
                        font: {
                            size: 11
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: {
                            size: 10
                        },
                        maxTicksLimit: 5,
                        callback: function(value) {
                            return '$' + (value/1000).toFixed(0) + 'K';
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 10
                        }
                    }
                }
            },
            layout: {
                padding: {
                    top: 10,
                    bottom: 10
                }
            }
        }
    });

    // Gráfico de flujo de efectivo
    const cashFlowCtx = document.getElementById('cashFlowChart').getContext('2d');
    new Chart(cashFlowCtx, {
        type: 'doughnut',
        data: {
            labels: ['Ingresos', 'Egresos'],
            datasets: [{
                data: [{{ ingresos|unlocalize }}, {{ egresos|unlocalize }}],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 10
                        },
                        boxWidth: 12,
                        padding: 10
                    }
                }
            },
            layout: {
                padding: {
                    top: 10,
                    bottom: 5
                }
            }
        }
    });

    // Aplicar inclinación a la balanza según el balance
    document.addEventListener('DOMContentLoaded', function() {
        const scaleBeam = document.querySelector('.scale-beam');
        const scaleLeft = document.querySelector('.scale-left');
        const scaleRight = document.querySelector('.scale-right');
        
        // Validar que balance_angle sea un número válido
        let balanceAngle = {% if balance_angle %}{{ balance_angle|unlocalize }}{% else %}0{% endif %};
        
        // Asegurar que sea un número
        if (isNaN(balanceAngle) || balanceAngle === null || balanceAngle === undefined) {
            balanceAngle = 0;
        }
        
        if (scaleBeam) {
            // Inclinar la viga principal
            scaleBeam.style.transform = `translate(-50%, -50%) rotate(${balanceAngle}deg)`;
        }
        
        if (scaleLeft && scaleRight) {
            // Inclinar ligeramente los platillos en dirección opuesta para realismo
            const plateAngle = balanceAngle * 0.3; // Reducir el ángulo para los platillos
            scaleLeft.style.transform = `rotate(${-plateAngle}deg)`;
            scaleRight.style.transform = `rotate(${plateAngle}deg)`;
        }
    });



    // Inicializar DataTables con validación
    function initializeDataTables() {
        // Configuración común para todas las tablas
        const commonConfig = {
            "pageLength": 10,
            "lengthMenu": [5, 10, 25, 50],
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": false,
            "responsive": true,
            "language": {
                "lengthMenu": "_MENU_ registros por página",
                "zeroRecords": "Sin registros encontrados",
                "info": "Mostrando página _PAGE_ de _PAGES_",
                "infoEmpty": "Sin registros disponibles",
                "infoFiltered": "(filtrado de _MAX_ registros totales)",
                "search": "Buscar:",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            }
        };

        // Función auxiliar para verificar si una tabla tiene filas
        function hasTableRows(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return false;
            
            const tbody = table.querySelector('tbody');
            if (!tbody) return false;
            
            const rows = tbody.querySelectorAll('tr');
            return rows.length > 0;
        }

        // Inicializar tabla de proveedores si tiene datos
        if (hasTableRows('tableProveedores')) {
            try {
                $('#tableProveedores').DataTable(commonConfig);
            } catch (e) {
                console.log('Error inicializando DataTable proveedores:', e);
            }
        }

        // Inicializar tabla de clientes si tiene datos
        if (hasTableRows('tableClientes')) {
            try {
                $('#tableClientes').DataTable(commonConfig);
            } catch (e) {
                console.log('Error inicializando DataTable clientes:', e);
            }
        }

        // Inicializar tabla de cobros si tiene datos
        if (hasTableRows('tableCobros')) {
            try {
                $('#tableCobros').DataTable(commonConfig);
            } catch (e) {
                console.log('Error inicializando DataTable cobros:', e);
            }
        }

        // Inicializar tabla de pagos si tiene datos
        if (hasTableRows('tablePagos')) {
            try {
                $('#tablePagos').DataTable(commonConfig);
            } catch (e) {
                console.log('Error inicializando DataTable pagos:', e);
            }
        }
    }

    // Inicializar DataTables cuando el DOM esté listo
    $(document).ready(function() {
        // Pequeño delay para asegurar que todo esté cargado
        setTimeout(initializeDataTables, 100);
    });

    // Funciones auxiliares
    function clearFilters() {
        document.getElementById('filterForm').reset();
        document.getElementById('filterForm').submit();
    }

    function exportReport() {
        alert('Función de exportación por implementar');
    }
</script>
{% endblock %}
