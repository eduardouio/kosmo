{% extends 'base/base.html' %}
{% block content %}
<h1 class="font-bold mb-4">Detalle Vendedor</h1>

<div class="bg-white shadow-md rounded-lg p-4 mb-4">
	<div class="row g-3">
		<div class="col-md-3 text-center">
			{% if object.picture %}
				<img src="{{ object.picture.url }}" alt="Foto" class="img-fluid rounded border" style="max-height:160px;object-fit:cover;">
			{% else %}
				<div class="d-flex flex-column justify-content-center align-items-center border rounded py-4 bg-light" style="height:160px;">
					<i class="la la-user-circle" style="font-size:3rem;opacity:.4;"></i>
					<span class="small text-muted">Sin foto</span>
				</div>
			{% endif %}
			<div class="mt-3">
				<span class="badge bg-primary">{{ object.roles }}</span>
				{% if object.is_active %}
					<span class="badge bg-success">Activo</span>
				{% else %}
					<span class="badge bg-danger">Inactivo</span>
				{% endif %}
			</div>
		</div>
		<div class="col-md-9">
			<div class="row g-2">
				<div class="col-md-6">
					<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
						<label class="small mb-0 text-muted">Nombre</label>
						<span class="fw-semibold">{{ object.first_name }} {{ object.last_name }}</span>
					</div>
				</div>
				<div class="col-md-6">
					<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
						<label class="small mb-0 text-muted">Correo</label>
						<span class="fw-semibold">{{ object.email }}</span>
					</div>
				</div>
				<div class="col-md-6">
					<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
						<label class="small mb-0 text-muted">Teléfono</label>
						<span class="fw-semibold">{{ object.phone|default:'-' }}</span>
					</div>
				</div>
				<div class="col-md-6">
					<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
						<label class="small mb-0 text-muted">Correo Confirmado</label>
						{% if object.is_confirmed_mail %}
							<span class="badge bg-success">Sí</span>
						{% else %}
							<span class="badge bg-secondary">No</span>
						{% endif %}
					</div>
				</div>
				<div class="col-md-6">
					<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
						<label class="small mb-0 text-muted">Meta Ventas</label>
						<span class="fw-semibold">{{ object.goal_sales }}</span>
					</div>
				</div>
				<div class="col-md-6">
					<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
						<label class="small mb-0 text-muted">Meta Tallos</label>
						<span class="fw-semibold">{{ object.goal_stems }}</span>
					</div>
				</div>
				{% if object.notes %}
				<div class="col-12">
					<div class="bg-gray-100 border border-gray-300 p-2">
						<label class="small mb-1 text-muted d-block">Notas</label>
						<span class="fw-semibold">{{ object.notes }}</span>
					</div>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<h5 class="fw-bold mt-4 mb-2">Metadatos</h5>
<div class="bg-white shadow-sm rounded-lg p-3 mb-4">
	<div class="row g-2">
		<div class="col-md-3">
			<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
				<label class="small mb-0 text-muted">ID</label>
				<span class="fw-semibold">{{ object.id }}</span>
			</div>
		</div>
		<div class="col-md-3">
			<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
				<label class="small mb-0 text-muted">Registrado</label>
				<span class="fw-semibold">{{ object.date_joined|date:'Y-m-d H:i' }}</span>
			</div>
		</div>
		<div class="col-md-3">
			<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
				<label class="small mb-0 text-muted">Último Login</label>
				<span class="fw-semibold">{{ object.last_login|default:'-'|date:'Y-m-d H:i' }}</span>
			</div>
		</div>
		<div class="col-md-3">
			<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
				<label class="small mb-0 text-muted">Staff</label>
				{% if object.is_staff %}<span class="badge bg-info">Sí</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}
			</div>
		</div>
		<div class="col-md-3">
			<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
				<label class="small mb-0 text-muted">Superusuario</label>
				{% if object.is_superuser %}<span class="badge bg-warning text-dark">Sí</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}
			</div>
		</div>
		<div class="col-md-3">
			<div class="bg-gray-100 border border-gray-300 p-2 d-flex justify-content-between align-items-center">
				<label class="small mb-0 text-muted">Estado</label>
				{% if object.is_active %}<span class="badge bg-success">Activo</span>{% else %}<span class="badge bg-danger">Inactivo</span>{% endif %}
			</div>
		</div>
	</div>
</div>

<div class="d-flex flex-wrap gap-2 mt-3">
	<button type="button" class="btn btn-sm bg-gray-300 border border-gray-400" disabled>
		<i class="la la-edit me-1"></i> Editar
	</button>
	{% if object.is_active %}
	<button id="btnToggleActive" data-active="1" class="btn btn-sm btn-danger border border-danger-subtle">
		<i class="la la-ban me-1"></i> Bloquear
	</button>
	{% else %}
	<button id="btnToggleActive" data-active="0" class="btn btn-sm btn-success border border-success-subtle">
		<i class="la la-unlock me-1"></i> Activar
	</button>
	{% endif %}
	<button id="btnOpenReset" class="btn btn-sm btn-warning border border-warning-subtle" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">
		<i class="la la-key me-1"></i> Resetear Clave
	</button>
	<a href="{% url 'sellers_list' %}" class="btn btn-sm bg-gray-300 border border-gray-400">
		<i class="la la-arrow-left me-1"></i> Volver
	</a>
</div>

<p class="text-muted small mt-4">(Acciones próximamente: bloquear/desbloquear, reset de contraseña, edición avanzada)</p>

<!-- Modal Reset Password -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Resetear Clave Vendedor</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="alert alert-danger d-none" id="resetError"></div>
				<div class="alert alert-success d-none" id="resetSuccess"></div>
				<form id="formResetPassword">
					<input type="hidden" name="target_user_id" value="{{ object.id }}">
					<div class="mb-3">
						<label class="form-label">Nueva Clave</label>
						<input type="password" class="form-control form-control-sm" name="new_password" required minlength="8">
					</div>
					<div class="mb-3">
						<label class="form-label">Confirmar Clave</label>
						<input type="password" class="form-control form-control-sm" name="confirm_password" required minlength="8">
					</div>
				</form>
				<small class="text-muted">La contraseña debe tener al menos 8 caracteres.</small>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
				<button type="button" id="btnSubmitReset" class="btn btn-sm btn-primary">Guardar</button>
			</div>
		</div>
	</div>
</div>

{% block script %}
{{ block.super }}
<script>
 (function(){
	 const csrfToken = '{{ csrf_token }}';
	 const sellerId = '{{ object.id }}';
	 const btnToggle = document.getElementById('btnToggleActive');
	 const btnSubmitReset = document.getElementById('btnSubmitReset');
	 const formReset = document.getElementById('formResetPassword');
	 const alertErr = document.getElementById('resetError');
	 const alertOk = document.getElementById('resetSuccess');

	 function showMsg(el, msg){
		 el.textContent = msg; el.classList.remove('d-none');
		 setTimeout(()=> el.classList.add('d-none'), 5000);
	 }

	 // Toggle activo
	 if(btnToggle){
		 btnToggle.addEventListener('click', async ()=>{
			 btnToggle.disabled = true;
			 try{
				 const resp = await fetch('/api/users/update/', {
					 method: 'POST',
					 headers: {
						 'Content-Type':'application/json',
						 'X-CSRFToken': csrfToken,
						 'X-Requested-With':'XMLHttpRequest'
					 },
					 body: JSON.stringify({
						 action: 'admin_toggle_active',
						 target_user_id: sellerId
					 })
				 });
				 const data = await resp.json();
				 if(!resp.ok){ throw new Error(data.detail || 'Error cambiando estado'); }
				 // Recargar para reflejar
				 location.reload();
			 }catch(err){
				 alert(err.message);
			 }finally{ btnToggle.disabled = false; }
		 });
	 }

	 // Reset password
	 if(btnSubmitReset){
		 btnSubmitReset.addEventListener('click', async ()=>{
			 alertErr.classList.add('d-none');
			 alertOk.classList.add('d-none');
			 const fd = new FormData(formReset);
			 const new_password = fd.get('new_password');
			 const confirm_password = fd.get('confirm_password');
			 if(!new_password || new_password.length < 8){
				 showMsg(alertErr, 'La contraseña mínima es de 8 caracteres');
				 return;
			 }
			 if(new_password !== confirm_password){
				 showMsg(alertErr, 'Las contraseñas no coinciden');
				 return;
			 }
			 btnSubmitReset.disabled = true;
			 try{
				 const payload = {
					 action: 'admin_reset_password',
					 target_user_id: sellerId,
					 new_password: new_password,
					 confirm_password: confirm_password
				 };
				 const resp = await fetch('/api/users/update/', {
					 method: 'POST',
					 headers: {
						 'Content-Type':'application/json',
						 'X-CSRFToken': csrfToken,
						 'X-Requested-With':'XMLHttpRequest'
					 },
					 body: JSON.stringify(payload)
				 });
				 const data = await resp.json();
				 if(!resp.ok){ throw new Error(data.detail || 'Error reseteando clave'); }
				 showMsg(alertOk, 'Contraseña reseteada correctamente');
				 formReset.reset();
				 setTimeout(()=>{
					 const modalEl = document.getElementById('resetPasswordModal');
					 const modalInstance = bootstrap.Modal.getInstance(modalEl);
					 modalInstance && modalInstance.hide();
				 },1500);
			 }catch(err){ showMsg(alertErr, err.message); }
			 finally{ btnSubmitReset.disabled = false; }
		 });
	 }
 })();
</script>
{% endblock %}

{% endblock %}
