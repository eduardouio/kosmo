{% extends 'base/base.html' %}

  {% block content %}
<div class="container">
  <div class="bg-light py-4">
    <div class="bg-white shadow-lg border border-2 border-warning rounded-3 p-4 mx-auto">
      <!-- Encabezado -->
      <div class="row">
        <div class="col text-center fs-2 text-kosmo-secondary">
          DETALLE DE ORDEN DE {% if response_data.order.type_document == "ORD_VENTA" %}VENTA{% else %}COMPRA{% endif %}
        </div>
        <div class="row">
         <span class="text-cyan-700 fs-6 upper">
           Orden de {% if response_data.order.type_document == "ORD_VENTA" %}Venta{% else %}Compra{% endif %} 
           <strong>
             {{ response_data.order.status }}
           </strong>
         </span>

        </div>
      </div>
      <div class="row mb-4 align-items-center">
        <div class="col-9">
          <img src="https://kosmoflowers.com/wp-content/uploads/2022/07/Mesa-de-trabajo-6.svg" class="img-fluid" style="height: 60px"/>
        </div>
        <div class="col-3">
          <div class="border border-2 border-warning p-2 rounded">
            <div class="d-flex justify-content-end align-items-center mb-1">
              <span class="small fw-bold me-2">PEDIDO:</span>
              <span class="text-danger fs-4">{{ response_data.order.serie }}-{{ response_data.order.consecutive | stringformat:'06d' }}</span>
            </div>
            <div class="d-flex justify-content-end align-items-center border-top border-success pt-1">
              <span class="small fw-bold me-2">FECHA:</span>
              <span class="fs-4">{{ response_data.order.date }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Información del cliente y proveedor -->
      <div class="row mb-4">
        <div class="col-6">
          <div class="border border-2 border-warning p-3 rounded h-100">
            <h6 class="fw-bold mb-3">Información del {% if response_data.order.type_document == 'ORD_VENTA' %} Cliente{% else %} Proveedor{% endif %}</h6>
            <div class="form-control bg-light">
              {{ response_data.customer.name }}
            </div>
            <div>
              <p class="small mb-1"><strong>Dirección:</strong> {{ response_data.customer.address|default:'No disponible' }}</p>
              <p class="small mb-1"><strong>Ciudad - País:</strong> {{ response_data.customer.city|default:'No disponible' }} - {{ response_data.customer.country|default:'No disponible' }}</p>
              <div class="d-flex justify-content-between">
                <p class="small mb-1"><strong>Email:</strong> {{ response_data.customer.email|default:'No disponible' }}</p>
                <p class="small mb-1"><strong>Crédito:</strong> {{ response_data.customer.credit_term|default:'No disponible' }}</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-6">
          {% if response_data.order.type_document == 'ORD_VENTA' %}
          <div class="border border-2 border-warning p-3 rounded h-100">
            <h6 class="fw-bold mb-3">Información del Proveedor</h6>
            <div class="form-control bg-light">
              {{ response_data.supplier.name }}
            </div>
            <div>
              <p class="small mb-1"><strong>Dirección:</strong> {{ response_data.supplier.address|default:'No disponible' }}</p>
              <p class="small mb-1"><strong>Ciudad - País:</strong> {{ response_data.supplier.city|default:'No disponible' }} - {{ response_data.supplier.country|default:'No disponible' }}</p>
              <div class="d-flex justify-content-between">
                <p class="small mb-1"><strong>Email:</strong> {{ response_data.supplier.email|default:'No disponible' }}</p>
                <p class="small mb-1"><strong>Crédito:</strong> {{ response_data.supplier.credit_term|default:'No disponible' }}</p>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Tabla de productos -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="table-responsive">
            <table class="table table-bordered table-sm table-hover">
              <thead class="bg-warning bg-opacity-25">
                <tr class="text-center small">
                  <th class="bg-gray-200">CANT</th>
                  <th class="bg-gray-200">MODELO</th>
                  <th class="bg-gray-200">VARIEDAD</th>
                  <th class="bg-gray-200">LARGO CM</th>
                  <th class="bg-gray-200">TOTAL TALLOS</th>
                  <th class="bg-gray-200">COSTO U</th>
                  <th class="bg-gray-200">PRECIO</th>
                  <th class="bg-gray-200">TOTAL</th>
                </tr>
              </thead>
              <tbody>
                {% for line in response_data.orderLines %}
                  {% for box_item in line.order_box_items %}
                  <tr>
                    {% if forloop.first %}
                      <td rowspan="{{ line.order_box_items|length }}" class="align-middle text-center">{{ line.quantity }}</td>
                      <td rowspan="{{ line.order_box_items|length }}" class="align-middle text-center">{{ line.box_model }}</td>
                    {% endif %}
                    <td>{{ box_item.product.variety }}</td>
                    <td class="text-end">{{ box_item.length }}</td>
                    <td class="text-end">{{ line.tot_stem_flower }}</td>
                    <td class="text-end">{{ box_item.stem_cost_price }}</td>
                    <td class="text-end">{{ box_item.stem_cost_total }}</td>
                    {% if response_data.order.type_document == 'ORD_VENTA' %}
                    <td class="text-end">{{ box_item.stem_cost_total_sale_with_quantity }}</td>
                    {% else %}
                    <td class="text-end">{{ box_item.stem_cost_total_price_with_quantity }}</td>
                    {% endif %}                   
                  </tr>
                  {% endfor %}
                {% endfor %}
              </tbody>
              <tfoot>
                <tr class="bg-warning bg-opacity-10">
                  <td colspan="7" class="text-end fw-bold">TOTAL GENERAL:</td>
                  {% if response_data.order.type_document == 'ORD_VENTA' %}
                  <td class="text-end text-success fw-bold">${{ response_data.order.total_order }}</td>
                  {%else%}
                  <td class="text-end text-success fw-bold">${{ response_data.order.total_price }}</td>
                  {%endif%}
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- Totales -->
      <div class="row mb-4">
        <div class="col-6">
          <div class="bg-light bg-gradient rounded shadow-sm p-3 border-gray-500">
            <div class="row">
              <div class="col-8 text-end border-end fs-5 fw-bold">TOTAL HB:</div>
              <div class="col-4 text-end fs-5 fw-bold">{{ response_data.order.hb_total }}</div>
            </div>
            <div class="row">
              <div class="col-8 text-end border-end fs-5 fw-bold">TOTAL QB:</div>
              <div class="col-4 text-end fs-5 fw-bold">{{ response_data.order.qb_total }}</div>
            </div>
            <div class="row">
              <div class="col-8 text-end border-end fs-5 fw-bold">TOTAL FB:</div>
              <div class="col-4 text-end fs-5 fw-bold">{{ response_data.order.fb_total }}</div>
            </div>
            <div class="row">
              <div class="col-8 text-end border-end fs-5 fw-bold">TOTAL TALLOS:</div>
              <div class="col-4 text-end fs-5 fw-bold">{{ response_data.order.total_stem_flower }}</div>
            </div>
          </div>
        </div>
        <div class="col-6">
          <div class="bg-light bg-gradient rounded shadow-sm p-3 border-gray-500">
            <div class="row mt-4">
              <div class="col-7 text-end border-end text-success fs-5"><strong>Costo:</strong></div>
              <div class="col-5 text-end text-success fs-5">${{ response_data.order.total_price }}</div>
            </div>
            <div class="row">
              <div class="col-7 text-end border-end text-success fs-5"><strong>Margen:</strong></div>
              <div class="col-5 text-end text-success fs-5">${{ response_data.order.total_margin }}</div>
            </div>
            <div class="row mb-1">
              <div class="col-7 text-end border-end text-success fs-5"><strong>Total Factura:</strong></div>
              <div class="col-5 text-end text-success fs-5">${{ response_data.order.total_order }}</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mensajes de acción -->
      {% if action %}
      <div class="row mt-4">
        <div class="col-12">
          <div class="alert {% if action == 'delete' %}alert-danger{% else %}alert-success{% endif %} text-center">
            {{ message }}
          </div>
        </div>
      </div>
      {% endif %}
      <div class="row">
         <div class="col d-flex justify-content-end gap-3">
          {% if  order.type_document == 'ORD_VENTA' and order.status == 'PENDIENTE' or order.status == 'MODIFICADO'%}
            <a href="/trade/{{ order.stock_day.pk }}/#/order-detail/{{ order.id }}/" class="btn btn-default btn-sm">
               <svg  xmlns="http://www.w3.org/2000/svg"  width="20"  height="20"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1.5"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-pencil"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>
               <span class="btn-text">Modificar</span>
            </a>
            {% endif %}
            {% if order.status == 'PROMESA' %}
              <a href="/trade/1/#/order/{{order.id}}/" class="btn btn-default btn-sm">
               <svg  xmlns="http://www.w3.org/2000/svg"  width="20"  height="20"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1.5"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-pencil"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>
               <span class="btn-text">Modificar</span>
            </a>
            {% endif %}
            {% if order.type_document == 'ORD_VENTA'  and order.is_invoiced == true %}
            <a href="#" class="btn btn-default btn-sm action-btn" data-action-url=" url 'aprove_purchase_order' order.id %}" data-confirm-text="Confirmar Operación">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="20"  height="20"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1.25"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-truck-delivery"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M5 17h-2v-4m-1 -8h11v12m-4 0h6m4 0h2v-6h-8m0 -5h5l3 5" /><path d="M3 9l4 0" /></svg>
              <span class="btn-text">Ordenes de Compra</span>
           </a>
            {% endif %}
            {% if order.status == 'CONFIRMADO' %}
            <a href="#" class="btn btn-default btn-sm action-btn" data-action-url=" url 'generate_invoice' order.id %}" data-confirm-text="Confirmar Generación de Factura">
               <svg  xmlns="http://www.w3.org/2000/svg"  width="20"  height="20"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1.5"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-receipt-dollar"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 21v-16a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v16l-3 -2l-2 2l-2 -2l-2 2l-2 -2l-3 2" /><path d="M14.8 8a2 2 0 0 0 -1.8 -1h-2a2 2 0 1 0 0 4h2a2 2 0 1 1 0 4h-2a2 2 0 0 1 -1.8 -1" /><path d="M12 6v10" /></svg>
               <span class="btn-text">Generar Factura</span>
            </a>
            {% endif %}
            {% if not order.is_invoiced and order.type_document == 'ORD_COMPRA' and order.status != 'CONFIRMADO' %}
           <a href="#" class="btn btn-default btn-sm action-btn needs-confirmation" data-action-url="{% url 'aprove_purchase_order' order.id %}" data-confirm-text="Confirmar Operación">
            <svg  xmlns="http://www.w3.org/2000/svg"  width="20"  height="20"  viewBox="0 0 24 24"  fill="currentColor"  class="icon icon-tabler icons-tabler-filled icon-tabler-copy-check"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18.333 6a3.667 3.667 0 0 1 3.667 3.667v8.666a3.667 3.667 0 0 1 -3.667 3.667h-8.666a3.667 3.667 0 0 1 -3.667 -3.667v-8.666a3.667 3.667 0 0 1 3.667 -3.667zm-3.333 -4c1.094 0 1.828 .533 2.374 1.514a1 1 0 1 1 -1.748 .972c-.221 -.398 -.342 -.486 -.626 -.486h-10c-.548 0 -1 .452 -1 1v9.998c0 .32 .154 .618 .407 .805l.1 .065a1 1 0 1 1 -.99 1.738a3 3 0 0 1 -1.517 -2.606v-10c0 -1.652 1.348 -3 3 -3zm1.293 9.293l-3.293 3.292l-1.293 -1.292a1 1 0 0 0 -1.414 1.414l2 2a1 1 0 0 0 1.414 0l4 -4a1 1 0 0 0 -1.414 -1.414" /></svg>
            <span class="btn-text">Confirmar</span> Compra</span>
         </a>
            {% endif %}
            {% if order.is_invoiced == false and order.type_document == 'ORD_VENTA' and order.status != 'CONFIRMADO' %}
           <a href="#" class="btn btn-default btn-sm action-btn needs-confirmation api-confirm" data-order-id="{{ order.id }}" data-confirm-text="Confirmar Venta">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icons-tabler-filled icon-tabler-copy-check"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18.333 6a3.667 3.667 0 0 1 3.667 3.667v8.666a3.667 3.667 0 0 1 -3.667 3.667h-8.666a3.667 3.667 0 0 1 -3.667 -3.667v-8.666a3.667 3.667 0 0 1 3.667 -3.667zm-3.333 -4c1.094 0 1.828 .533 2.374 1.514a1 1 0 1 1 -1.748 .972c-.221 -.398 -.342 -.486 -.626 -.486h-10c-.548 0 -1 .452 -1 1v9.998c0 .32 .154 .618 .407 .805l.1 .065a1 1 0 1 1 -.99 1.738a3 3 0 0 1 -1.517 -2.606v-10c0 -1.652 1.348 -3 3 -3zm1.293 9.293l-3.293 3.292l-1.293 -1.292a1 1 0 0 0 -1.414 1.414l2 2a1 1 0 0 0 1.414 0l4 -4a1 1 0 0 0 -1.414 -1.414" /></svg>
            <span class="btn-text">Confirmar Venta</span>
         </a>
            {% endif %}
            {% if order.is_invoiced  and order.type_document == 'ORD_VENTA' %}
            <a href="{% url 'invoice_detail_presentation' order.id_invoice %}" class="btn btn-default btn-sm action-btn">
              <svg  xmlns="http://www.w3.org/2000/svg"  width="20"  height="20"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="1.5"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-eye"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg>
              <span class="btn-text">Ver Factura</span>
           </a>
           <a href="{% url 'report_invoice' order.id_invoice %}" class="btn btn-default btn-sm action-btn">
            <svg  xmlns="http://www.w3.org/2000/svg"  width="20"  height="20"  viewBox="0 0 24 24"  fill="currentColor"  class="icon icon-tabler icons-tabler-filled icon-tabler-copy-check"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18.333 6a3.667 3.667 0 0 1 3.667 3.667v8.666a3.667 3.667 0 0 1 -3.667 3.667h-8.666a3.667 3.667 0 0 1 -3.667 -3.667v-8.666a3.667 3.667 0 0 1 3.667 -3.667zm-3.333 -4c1.094 0 1.828 .533 2.374 1.514a1 1 0 1 1 -1.748 .972c-.221 -.398 -.342 -.486 -.626 -.486h-10c-.548 0 -1 .452 -1 1v9.998c0 .32 .154 .618 .407 .805l.1 .065a1 1 0 1 1 -.99 1.738a3 3 0 0 1 -1.517 -2.606v-10c0 -1.652 1.348 -3 3 -3zm1.293 9.293l-3.293 3.292l-1.293 -1.292a1 1 0 0 0 -1.414 1.414l2 2a1 1 0 0 0 1.414 0l4 -4a1 1 0 0 0 -1.414 -1.414" /></svg>
            <span class="btn-text">Imprimir Factura</span>
         </a>
         {%endif%}
            {% if order.type_document == 'ORD_VENTA' %}
            <a href="{% url 'report_customer_order' order.id %}" class="btn btn-default btn-sm action-btn print-btn">
               <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-printer"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2" /><path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4" /><path d="M7 13m0 2a2 2 0 0 1 2 -2h6a2 2 0 0 1 2 2v4a2 2 0 0 1 -2 2h-6a2 2 0 0 1 -2 -2z" /></svg>
               <span class="btn-text">PDF Orden Venta</span>
            </a>
            {% else %}
            <a href="{% url 'report_supplier_order' order.id %}" class="btn btn-default btn-sm action-btn print-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-printer"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M17 17h2a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-14a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h2" /><path d="M17 9v-4a2 2 0 0 0 -2 -2h-6a2 2 0 0 0 -2 2v4" /><path d="M7 13m0 2a2 2 0 0 1 2 -2h6a2 2 0 0 1 2 2v4a2 2 0 0 1 -2 2h-6a2 2 0 0 1 -2 -2z" /></svg>
              <span class="btn-text">PDf Orden Compra</span>
           </a>
            {% endif %}
         </div>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const confirmButtons = document.querySelectorAll('.action-btn.needs-confirmation');
    const directActionButtons = document.querySelectorAll('.action-btn:not(.needs-confirmation)');
    const apiConfirmButtons = document.querySelectorAll('.action-btn.api-confirm');
    
    // Configurar botones de confirmación API
    apiConfirmButtons.forEach(btn => {
      let isConfirmState = false;
      const originalText = btn.querySelector('.btn-text').textContent;
      const confirmText = btn.getAttribute('data-confirm-text');
      const orderId = btn.getAttribute('data-order-id');
      
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!isConfirmState) {
          // Primer clic: cambiar a estado de confirmación
          btn.querySelector('.btn-text').textContent = confirmText;
          isConfirmState = true;
          
          // Establecer un temporizador para volver al estado original después de 3 segundos
          setTimeout(() => {
            if (isConfirmState) {
              btn.querySelector('.btn-text').textContent = originalText;
              isConfirmState = false;
            }
          }, 3000);
        } else {
          // Segundo clic: llamar a la API
          fetch('/api/confirm-purchase-order/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(orderId)
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'ok') {
              // Recargar la página después de una confirmación exitosa
              window.location.reload();
            } else {
              alert('Error al confirmar la orden');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error al confirmar la orden');
          });
        }
      });
    });
    
    // Configurar botones que requieren confirmación existentes
    confirmButtons.forEach(btn => {
      let isConfirmState = false;
      const originalText = btn.querySelector('.btn-text').textContent;
      const confirmText = btn.getAttribute('data-confirm-text');
      const actionUrl = btn.getAttribute('data-action-url');
      
      btn.addEventListener('click', function(e) {
        if (!isConfirmState) {
          // Primer clic: cambiar a estado de confirmación
          e.preventDefault();
          btn.querySelector('.btn-text').textContent = confirmText;
          isConfirmState = true;
          
          // Establecer un temporizador para volver al estado original después de 3 segundos
          setTimeout(() => {
            if (isConfirmState) {
              btn.querySelector('.btn-text').textContent = originalText;
              isConfirmState = false;
            }
          }, 3000);
        } else {
          // Segundo clic: ir a la URL de acción
          btn.href = actionUrl;
          // No es necesario prevenir el evento predeterminado para permitir la navegación
        }
      });
    });
    
    // Configurar botones de acción directa (sin confirmación)
    directActionButtons.forEach(btn => {
      const actionUrl = btn.getAttribute('data-action-url');
      if (actionUrl) {
        btn.addEventListener('click', function() {
          btn.href = actionUrl;
        });
      }
    });
    
    // Función para obtener cookies (para CSRF token)
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>
{% endblock %}
